import os
import win32com.client as win32
import re
from urllib.parse import quote
from pathlib import Path
import sys

# Configuración de rutas (ajusta según tu necesidad)
CARPETA_HTML = Path(r"C:\Users\Erick Baez\Documents\html a pdf\ejemplos")
CARPETA_SALIDA = Path(r"C:\Users\Erick Baez\Documents\html a pdf\ejemplos\salida")
URL_SHAREPOINT = "https://tubanco.sharepoint.com/sites/misitio/Documentos%20compartidos/Carpeta/"

# Crear carpeta de salida si no existe
CARPETA_SALIDA.mkdir(parents=True, exist_ok=True)

def detectar_encoding(archivo):
    """Intenta detectar el encoding del archivo HTML"""
    encodings = ['utf-8', 'iso-8859-1', 'windows-1252']
    for enc in encodings:
        try:
            with open(archivo, 'r', encoding=enc) as f:
                f.read()
            return enc
        except UnicodeDecodeError:
            continue
    return 'utf-8'  # Por defecto si no se puede detectar

def procesar_html(html_path):
    """Procesa el archivo HTML y ajusta rutas"""
    encoding = detectar_encoding(html_path)
    
    with open(html_path, 'r', encoding=encoding, errors='replace') as f:
        contenido = f.read()
    
    html_dir = html_path.parent
    
    # 1. Actualizar enlaces .htm/.html a PDFs en SharePoint
    patron_href = r'(href=["\'])((?!https?://|mailto:)[^"\']*\.htm[l]?)(["\'])'
    def actualizar_href(match):
        prefijo, nombre_archivo, sufijo = match.group(1), match.group(2), match.group(3)
        if not nombre_archivo.startswith(('http://', 'https://', 'mailto:')):
            nombre_base = Path(nombre_archivo).stem
            return f'{prefijo}{URL_SHAREPOINT}{quote(nombre_base)}.pdf{sufijo}'
        return match.group(0)
    
    contenido = re.sub(patron_href, actualizar_href, contenido, flags=re.IGNORECASE)
    
    # 2. Ajustar rutas de imágenes locales (solo si existen)
    patron_img = r'(src=["\'])((?!https?://|data:)[^"\']*\.(?:jpg|jpeg|png|gif|bmp|svg|webp|ico))(["\'])'
    def actualizar_img(match):
        prefijo, ruta_img, sufijo = match.group(1), match.group(2), match.group(3)
        
        if ruta_img.startswith(('http://', 'https://', 'data:')):
            return match.group(0)
            
        ruta_absoluta = (html_dir / ruta_img).resolve()
        
        if ruta_absoluta.exists():
            # Formato que Word entiende (ruta absoluta estilo UNIX)
            return f'{prefijo}file:///{ruta_absoluta.as_posix()}{sufijo}'
        
        # Si la imagen no existe, dejar la ruta original pero mostrar advertencia
        print(f"  [!] Imagen no encontrada: {ruta_img}")
        return match.group(0)
    
    contenido = re.sub(patron_img, actualizar_img, contenido, flags=re.IGNORECASE)
    
    return contenido

def convertir_a_word_pdf(html_path, output_dir):
    """Convierte el archivo HTML a Word y PDF"""
    nombre_base = html_path.stem
    temp_html = output_dir / f"temp_{html_path.name}"
    
    try:
        # Procesar y guardar HTML temporal
        contenido = procesar_html(html_path)
        temp_html.write_text(contenido, encoding='utf-8')
        
        # Iniciar Word
        word = win32.DispatchEx('Word.Application')  # Usar DispatchEx para nueva instancia
        word.Visible = False
        
        try:
            # Convertir a Word
            doc = word.Documents.Open(str(temp_html))
            
            # Guardar como DOCX
            docx_path = output_dir / f"{nombre_base}.docx"
            doc.SaveAs(str(docx_path), FileFormat=16)
            
            # Guardar como PDF
            pdf_path = output_dir / f"{nombre_base}.pdf"
            doc.SaveAs(str(pdf_path), FileFormat=17)
            
            doc.Close()
            return True
        except Exception as e:
            print(f"  [!] Error en Word: {str(e)}")
            return False
        finally:
            word.Quit()
    except Exception as e:
        print(f"  [!] Error general: {str(e)}")
        return False
    finally:
        if temp_html.exists():
            temp_html.unlink()

# Procesar todos los archivos HTML/HTM
print("Iniciando conversión...")
exitosos = 0

for html_file in CARPETA_HTML.glob("*.[hH][tT][mM]*"):
    print(f"\nProcesando: {html_file.name}")
    
    if convertir_a_word_pdf(html_file, CARPETA_SALIDA):
        print(f"  ✔ Convertido: {html_file.stem}.docx/pdf")
        exitosos += 1
    else:
        print(f"  ✖ Falló la conversión: {html_file.name}")

print(f"\nProceso completado. Archivos exitosos: {exitosos}")
if exitosos < len(list(CARPETA_HTML.glob("*.[hH][tT][mM]*"))):
    print("  [!] Algunos archivos no se pudieron convertir. Ver mensajes anteriores.")
