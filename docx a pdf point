import os
import win32com.client as win32
import re
from urllib.parse import quote

# Ruta local de la carpeta con los HTML
carpeta_html = r"C:\Users\Erick Baez\Documents\html a pdf\ejemplos"
carpeta_salida = r"C:\Users\Erick Baez\Documents\html a pdf\ejemplos\salida"

# URL base de SharePoint donde se guardarán/consultarán los PDFs
url_base_sharepoint = "https://tubanco.sharepoint.com/sites/misitio/Documentos%20compartidos/Carpeta/"

# Crear carpeta de salida si no existe
os.makedirs(carpeta_salida, exist_ok=True)

def actualizar_enlaces(contenido):
    """
    Actualiza los enlaces .htm/.html para que apunten a PDFs en SharePoint,
    excluyendo enlaces a imágenes y otros recursos.
    """
    # Patrón para encontrar href que apunten a archivos .htm/.html pero no a imágenes
    patron = r'href=["\']((?!.*\.(jpg|jpeg|png|gif|bmp|svg|webp|ico))[^"\']+\.htm[l]?)["\']'
    
    def reemplazar_enlace(match):
        nombre_archivo = match.group(1)
        nombre_base = os.path.splitext(nombre_archivo)[0]
        
        # Codificar caracteres especiales para URL
        nombre_codificado = quote(f"{nombre_base}.pdf")
        
        # Construir URL completa de SharePoint
        return f'href="{url_base_sharepoint}{nombre_codificado}"'
    
    return re.sub(patron, reemplazar_enlace, contenido, flags=re.IGNORECASE)

# Iniciar Word
word = win32.Dispatch('Word.Application')
word.Visible = False

for archivo in os.listdir(carpeta_html):
    if archivo.lower().endswith((".htm", ".html")):
        ruta_html = os.path.join(carpeta_html, archivo)
        nombre_base = os.path.splitext(archivo)[0]

        print(f"Procesando: {archivo}")

        try:
            # Leer y actualizar contenido
            with open(ruta_html, 'r', encoding='utf-8', errors='ignore') as f:
                contenido = f.read()
            
            contenido_actualizado = actualizar_enlaces(contenido)

            # Guardar temporalmente
            ruta_temp = os.path.join(carpeta_salida, f"temp_{archivo}")
            with open(ruta_temp, 'w', encoding='utf-8') as f:
                f.write(contenido_actualizado)

            # Procesar con Word
            doc = word.Documents.Open(ruta_temp)
            
            # Guardar resultados
            ruta_docx = os.path.join(carpeta_salida, f"{nombre_base}.docx")
            doc.SaveAs(ruta_docx, FileFormat=16)
            
            ruta_pdf = os.path.join(carpeta_salida, f"{nombre_base}.pdf")
            doc.SaveAs(ruta_pdf, FileFormat=17)
            
            doc.Close()
            os.remove(ruta_temp)
            
        except Exception as e:
            print(f"Error procesando {archivo}: {str(e)}")

# Cerrar Word
word.Quit()

print("✅ Conversión completada con enlaces directos a SharePoint")
