import os
import win32com.client as win32
import re

# Ruta local de la carpeta con los HTML
carpeta_html = r"C:\Users\Erick Baez\Documents\html a pdf\ejemplos"
carpeta_salida = r"C:\Users\Erick Baez\Documents\html a pdf\ejemplos\salida"

# URL base de SharePoint donde se guardarán/consultarán los PDFs
url_base_sharepoint = "https://tubanco.sharepoint.com/sites/misitio/Documentos%20compartidos/Carpeta/"

# Crear carpeta de salida si no existe
os.makedirs(carpeta_salida, exist_ok=True)

# Función para actualizar los enlaces en el contenido HTML
def actualizar_enlaces(contenido):
    # Buscar enlaces que apunten a archivos .htm o .html
    patron = r'href=["\']([^"\']+\.htm[l]?)["\']'
    
    def reemplazar_enlace(match):
        nombre_archivo = match.group(1)
        nombre_base = os.path.splitext(nombre_archivo)[0]
        # Aquí cambiamos el enlace para que apunte a SharePoint
        return f'href="{url_base_sharepoint}{nombre_base}.pdf"'
    
    return re.sub(patron, reemplazar_enlace, contenido, flags=re.IGNORECASE)

# Iniciar Word
word = win32.Dispatch('Word.Application')
word.Visible = False  # No mostrar ventana

for archivo in os.listdir(carpeta_html):
    if archivo.lower().endswith((".htm", ".html")):
        ruta_html = os.path.join(carpeta_html, archivo)
        nombre_base = os.path.splitext(archivo)[0]

        print(f"Procesando: {archivo}")

        # Leer el contenido HTML y actualizar enlaces
        with open(ruta_html, 'r', encoding='utf-8') as f:
            contenido = f.read()
        
        contenido_actualizado = actualizar_enlaces(contenido)

        # Guardar temporalmente el HTML modificado
        ruta_temp = os.path.join(carpeta_salida, f"temp_{archivo}")
        with open(ruta_temp, 'w', encoding='utf-8') as f:
            f.write(contenido_actualizado)

        # Abrir HTML modificado en Word
        doc = word.Documents.Open(ruta_temp)

        # Guardar como DOCX
        ruta_docx = os.path.join(carpeta_salida, f"{nombre_base}.docx")
        doc.SaveAs(ruta_docx, FileFormat=16)  # 16 = Word (.docx)

        # Guardar como PDF
        ruta_pdf = os.path.join(carpeta_salida, f"{nombre_base}.pdf")
        doc.SaveAs(ruta_pdf, FileFormat=17)  # 17 = PDF

        doc.Close()
        
        # Eliminar archivo temporal
        os.remove(ruta_temp)

# Cerrar Word
word.Quit()

print("✅ Conversión completada con enlaces a SharePoint")
