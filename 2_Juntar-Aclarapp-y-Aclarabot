import pandas as pd
import logging
from pathlib import Path
import unicodedata
import re

# =========================
# LOGGING
# =========================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

# =========================
# CONFIGURACIÃ“N
# =========================
BASE_PATH = Path("c:/Copia-reporte-Aclarabot")

ACLARABOT_PATH = next(BASE_PATH.glob("*.csv"))  # ej: 06-Jan.csv
ACLARAPP_PATH = BASE_PATH / "Copy-Aclarapp" / "TablaCopiadaDeAclarapp.csv"
AGENTES_PATH = BASE_PATH / "Copy-Aclarapp" / "InfoAgentes.csv"

OUTPUT_FILE = BASE_PATH / "Acumulado_filtrado_11-Dec.csv"

# =========================
# FUNCIONES
# =========================
def normalizar_columna(col):
    col = col.strip()
    col = unicodedata.normalize("NFKD", col)
    col = col.encode("ascii", "ignore").decode("utf-8")
    return col

def cargar_csv(ruta, sep=","):
    df = pd.read_csv(
        ruta,
        sep=sep,
        dtype=str,
        encoding="utf-8-sig",
        on_bad_lines="warn"
    )
    df.columns = [normalizar_columna(c) for c in df.columns]
    df = df.apply(lambda col: col.str.strip() if col.dtype == "object" else col)
    return df

def limpiar_formato_fecha_especial(valor):
    """
    Limpia formato especial: dd/MM/yyyy hh:mm:ss p. m. (con espacio entre p. y m.)
    y a. m.
    """
    if pd.isna(valor):
        return valor
    
    valor_str = str(valor).strip()
    
    if not valor_str or valor_str.lower() in ['nan', 'nat', 'null', 'none', '']:
        return valor
    
    # Corregir el espacio entre p. y m. / a. y m.
    valor_str = re.sub(r'p\.\s*m\.', 'PM', valor_str, flags=re.IGNORECASE)
    valor_str = re.sub(r'a\.\s*m\.', 'AM', valor_str, flags=re.IGNORECASE)
    
    # TambiÃ©n manejar sin puntos pero con espacio: "p m" o "a m"
    valor_str = re.sub(r'p\s+m', 'PM', valor_str, flags=re.IGNORECASE)
    valor_str = re.sub(r'a\s+m', 'AM', valor_str, flags=re.IGNORECASE)
    
    # Si todavÃ­a quedan puntos en AM/PM, quitarlos
    valor_str = re.sub(r'\bp\.m\.\b', 'PM', valor_str, flags=re.IGNORECASE)
    valor_str = re.sub(r'\ba\.m\.\b', 'AM', valor_str, flags=re.IGNORECASE)
    
    # Quitar espacios extra alrededor de AM/PM
    valor_str = re.sub(r'\s+([AP]M)\s*$', r' \1', valor_str)
    
    # Asegurar un solo espacio entre la hora y AM/PM
    valor_str = re.sub(r'(\d)\s+([AP]M)$', r'\1 \2', valor_str)
    
    return valor_str.strip()

def convertir_fecha_a_formato_iso(valor):
    """
    Convierte fecha a formato ISO: yyyy-MM-dd HH:mm:ss
    """
    if pd.isna(valor):
        return valor
    
    valor_str = str(valor).strip()
    
    if not valor_str or valor_str.lower() in ['nan', 'nat', 'null', 'none', '']:
        return valor
    
    # Primero aplicar limpieza especial
    valor_limpio = limpiar_formato_fecha_especial(valor_str)
    
    try:
        # Intentar convertir de formato 12h a datetime
        fecha_dt = pd.to_datetime(
            valor_limpio,
            format="%d/%m/%Y %I:%M:%S %p",
            dayfirst=True,
            errors="raise"
        )
        
        # Convertir a string con formato ISO
        return fecha_dt.strftime("%Y-%m-%d %H:%M:%S")
        
    except Exception as e:
        logger.debug(f"No se pudo convertir con formato 12h: '{valor_str}' -> Error: {e}")
        
        try:
            # Intentar con formato 24h
            fecha_dt = pd.to_datetime(
                valor_limpio,
                format="%d/%m/%Y %H:%M:%S",
                dayfirst=True,
                errors="raise"
            )
            
            # Convertir a string con formato ISO
            return fecha_dt.strftime("%Y-%m-%d %H:%M:%S")
            
        except Exception as e2:
            logger.debug(f"No se pudo convertir con formato 24h: '{valor_str}' -> Error: {e2}")
            
            try:
                # Ãšltimo intento: parseo automÃ¡tico
                fecha_dt = pd.to_datetime(valor_limpio, dayfirst=True, errors="coerce")
                if pd.notna(fecha_dt):
                    return fecha_dt.strftime("%Y-%m-%d %H:%M:%S")
                else:
                    return valor_str
            except:
                return valor_str

def limpiar_cis(valor):
    """
    Limpia CIS para dejar solo nÃºmeros
    Elimina letras, sÃ­mbolos, espacios, etc.
    """
    if pd.isna(valor):
        return valor
    
    valor_str = str(valor).strip()
    
    if not valor_str or valor_str.lower() in ['nan', 'nat', 'null', 'none', '']:
        return valor
    
    # Eliminar todo excepto nÃºmeros
    solo_numeros = re.sub(r'[^0-9]', '', valor_str)
    
    # Si despuÃ©s de limpiar queda vacÃ­o, devolver None
    if solo_numeros == '':
        return None
    
    return solo_numeros

# =========================
# MAIN
# =========================
def main():
    logger.info("ðŸš€ Iniciando merge ACLARABOT + ACLARAPP + INFOAGENTES")

    # =========================
    # CARGA ARCHIVOS
    # =========================
    aclarabot_df = cargar_csv(ACLARABOT_PATH)
    logger.info(f"âœ“ Aclarabot cargado: {ACLARABOT_PATH.name} ({len(aclarabot_df)} filas)")
    
    if "Fecha" in aclarabot_df.columns:
        logger.info(f"ðŸ“‹ Ejemplos de formato 'Fecha' en Aclarabot (primeras 5):")
        for i in range(min(5, len(aclarabot_df))):
            fecha_ejemplo = aclarabot_df['Fecha'].iloc[i]
            logger.info(f"  Fila {i}: '{fecha_ejemplo}'")

    aclarapp_df = cargar_csv(ACLARAPP_PATH, sep="|")
    logger.info(f"âœ“ Aclarapp cargado ({len(aclarapp_df)} filas)")
    
    # =========================
    # LIMPIAR COLUMNAS CIS Y CIS_2 (si existe)
    # =========================
    logger.info("\nðŸ§¹ LIMPIANDO COLUMNAS CIS (solo nÃºmeros)...")
    
    # Columnas CIS a limpiar
    columnas_cis = ["CIS", "CIS_2"]
    
    for col in columnas_cis:
        if col in aclarapp_df.columns:
            logger.info(f"Procesando columna: {col}")
            
            # Contar valores antes
            valores_antes = aclarapp_df[col].notna().sum()
            
            if valores_antes > 0:
                # Mostrar ejemplos antes
                ejemplos_antes = aclarapp_df[col].dropna().head(3).tolist()
                logger.info(f"  Ejemplos ANTES de limpiar:")
                for i, ejemplo in enumerate(ejemplos_antes):
                    logger.info(f"    {i}: '{ejemplo}'")
                
                # Aplicar limpieza
                aclarapp_df[col] = aclarapp_df[col].apply(limpiar_cis)
                
                # Mostrar ejemplos despuÃ©s
                ejemplos_despues = aclarapp_df[col].dropna().head(3).tolist()
                logger.info(f"  Ejemplos DESPUÃ‰S de limpiar:")
                for i, ejemplo in enumerate(ejemplos_despues):
                    logger.info(f"    {i}: '{ejemplo}'")
                
                # Contar valores despuÃ©s
                valores_despues = aclarapp_df[col].notna().sum()
                logger.info(f"  Valores antes/despuÃ©s: {valores_antes}/{valores_despues}")

    # =========================
    # CONVERTIR FECHAS DE ACLARAPP A FORMATO ISO
    # =========================
    logger.info("\nðŸ”„ CONVIRTIENDO FECHAS DE ACLARAPP A FORMATO ISO (yyyy-MM-dd HH:mm:ss)")
    
    columnas_fecha_aclaraapp = [
        "Fecha CreaciÃ³n", 
        "Fecha Enviado", 
        "Fecha Asignacion", 
        "Fecha Atendido"
    ]
    
    for col in columnas_fecha_aclaraapp:
        if col in aclarapp_df.columns:
            logger.info(f"Procesando columna Aclarapp: {col}")
            
            # Contar valores no nulos
            valores_no_nulos = aclarapp_df[col].notna().sum()
            logger.info(f"  Valores no nulos: {valores_no_nulos}")
            
            if valores_no_nulos > 0:
                # Mostrar ejemplos antes de la conversiÃ³n
                ejemplos_antes = aclarapp_df[col].dropna().head(3).tolist()
                logger.info(f"  Ejemplos ANTES de conversiÃ³n:")
                for i, ejemplo in enumerate(ejemplos_antes):
                    logger.info(f"    {i}: '{ejemplo}'")
                
                # Aplicar conversiÃ³n a formato ISO
                aclarapp_df[col] = aclarapp_df[col].apply(convertir_fecha_a_formato_iso)
                
                # Mostrar ejemplos despuÃ©s de la conversiÃ³n
                ejemplos_despues = aclarapp_df[col].dropna().head(3).tolist()
                logger.info(f"  Ejemplos DESPUÃ‰S de conversiÃ³n:")
                for i, ejemplo in enumerate(ejemplos_despues):
                    logger.info(f"    {i}: '{ejemplo}'")
                
                # Verificar formato ISO
                formatos_correctos = 0
                for ejemplo in ejemplos_despues:
                    if isinstance(ejemplo, str) and re.match(r'^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$', ejemplo):
                        formatos_correctos += 1
                
                logger.info(f"  âœ… Formatos ISO correctos: {formatos_correctos}/{len(ejemplos_despues)}")

    agentes_df = cargar_csv(AGENTES_PATH, sep="|")
    logger.info(f"âœ“ InfoAgentes cargado ({len(agentes_df)} filas)")

    # =========================
    # AJUSTES DE COLUMNAS
    # =========================
    if "CIS" in aclarapp_df.columns:
        aclarapp_df.rename(columns={"CIS": "CIS_2"}, inplace=True)

    # =========================
    # MERGE 1: ACLARABOT + ACLARAPP
    # =========================
    merge_1 = aclarabot_df.merge(
        aclarapp_df,
        how="left",
        left_on="AclaracionID",
        right_on="ID Aclaracion",
        suffixes=("", "_DUP"),
        indicator=True
    )

    logger.info(f"Merge Aclarapp: {merge_1['_merge'].value_counts().to_dict()}")
    merge_1.drop(columns=["_merge"], inplace=True)

    # =========================
    # MERGE 2: + INFOAGENTES
    # =========================
    df_final = merge_1.merge(
        agentes_df,
        how="left",
        left_on="Numero de registro",
        right_on="ID",
        suffixes=("", "_AGENTE"),
        indicator=True
    )

    logger.info(f"Merge Agentes: {df_final['_merge'].value_counts().to_dict()}")
    df_final.drop(columns=["_merge"], inplace=True)

    # =========================
    # CONVERTIR FECHA PRINCIPAL (de Aclarabot) A FORMATO ISO
    # =========================
    logger.info("\nðŸ”„ Convirtiendo columna 'Fecha' (de Aclarabot) a formato ISO...")
    
    if "Fecha" in df_final.columns:
        logger.info(f"Procesando columna: Fecha")
        
        valores_originales = df_final["Fecha"].notna().sum()
        logger.info(f"  Valores no nulos originales: {valores_originales}")
        
        if valores_originales > 0:
            # Mostrar ejemplos originales
            ejemplos = df_final["Fecha"].dropna().head(3).tolist()
            logger.info(f"  Ejemplos originales:")
            for i, ejemplo in enumerate(ejemplos):
                logger.info(f"    {i}: '{ejemplo}'")
        
        # Aplicar conversiÃ³n a formato ISO
        df_final["Fecha"] = df_final["Fecha"].apply(convertir_fecha_a_formato_iso)
        
        # Verificar conversiÃ³n
        convertidos = df_final["Fecha"].notna().sum()
        logger.info(f"  âœ… Fechas convertidas: {convertidos}/{valores_originales}")
        
        if convertidos > 0:
            # Mostrar ejemplos despuÃ©s de conversiÃ³n
            ejemplos_final = df_final["Fecha"].dropna().head(3).tolist()
            logger.info(f"  Ejemplos finales (formato ISO):")
            for i, ejemplo in enumerate(ejemplos_final):
                logger.info(f"    {i}: '{ejemplo}'")

    # =========================
    # ORDENAR POR FECHA (de mÃ¡s antigua a mÃ¡s actual)
    # =========================
    if "Fecha" in df_final.columns:
        logger.info(f"\nðŸ“Š Ordenando por columna 'Fecha'...")
        
        # Crear columna temporal para ordenar
        df_final['Fecha_temp'] = pd.to_datetime(df_final['Fecha'], errors='coerce')
        
        fechas_validas = df_final['Fecha_temp'].notna().sum()
        logger.info(f"  Fechas vÃ¡lidas para ordenar: {fechas_validas}/{len(df_final)}")
        
        if fechas_validas > 0:
            fecha_min = df_final['Fecha_temp'].min()
            fecha_max = df_final['Fecha_temp'].max()
            logger.info(f"  Rango de fechas: {fecha_min} a {fecha_max}")
            
            df_final.sort_values('Fecha_temp', inplace=True, na_position="last")
            
            primera_fecha = df_final['Fecha_temp'].iloc[0] if fechas_validas > 0 else None
            ultima_fecha_valida = df_final['Fecha_temp'].iloc[fechas_validas-1] if fechas_validas > 0 else None
            
            logger.info(f"  Primera fecha despuÃ©s de ordenar: {primera_fecha}")
            logger.info(f"  Ãšltima fecha vÃ¡lida: {ultima_fecha_valida}")
            
            # Eliminar columna temporal
            df_final.drop(columns=['Fecha_temp'], inplace=True)
        else:
            logger.warning("  âš ï¸ No hay fechas vÃ¡lidas para ordenar")
            # Eliminar columna temporal si existe
            if 'Fecha_temp' in df_final.columns:
                df_final.drop(columns=['Fecha_temp'], inplace=True)
    else:
        logger.warning("âš ï¸ No se encontrÃ³ columna 'Fecha' para ordenar")

    # =========================
    # VERIFICAR FORMATOS FINALES
    # =========================
    logger.info("\nðŸ” VERIFICANDO FORMATOS FINALES...")
    
    todas_columnas_fecha = [
        "Fecha", 
        "Fecha CreaciÃ³n", 
        "Fecha Enviado", 
        "Fecha Asignacion", 
        "Fecha Atendido"
    ]
    
    for col in todas_columnas_fecha:
        if col in df_final.columns:
            valores_no_nulos = df_final[col].notna().sum()
            if valores_no_nulos > 0:
                # Verificar formato ISO
                ejemplos = df_final[col].dropna().head(3).tolist()
                formatos_correctos = 0
                for ejemplo in ejemplos:
                    if isinstance(ejemplo, str) and re.match(r'^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$', ejemplo):
                        formatos_correctos += 1
                
                logger.info(f"{col:<20}: {valores_no_nulos:>5} valores | ISO correcto: {formatos_correctos}/{len(ejemplos)}")
                
                if formatos_correctos < len(ejemplos):
                    for i, ejemplo in enumerate(ejemplos):
                        if not re.match(r'^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$', str(ejemplo)):
                            logger.warning(f"    Formato incorrecto #{i}: '{ejemplo}'")

    # =========================
    # EXPORTAR CSV
    # =========================
    logger.info(f"\nðŸ“¤ Exportando a CSV: {OUTPUT_FILE}")
    df_final.to_csv(
        OUTPUT_FILE,
        index=False,
        encoding="utf-8-sig",
        date_format='%Y-%m-%d %H:%M:%S'  # Especificar formato para columnas datetime
    )

    logger.info("âœ… Archivo generado correctamente")
    logger.info(f"ðŸ“„ UbicaciÃ³n: {OUTPUT_FILE}")
    logger.info(f"ðŸ“Š Total filas: {len(df_final)}")
    
    # Resumen final
    logger.info("\nðŸ“Š RESUMEN FINAL:")
    logger.info("=" * 60)
    logger.info("FORMATO FECHAS: yyyy-MM-dd HH:mm:ss")
    for col in todas_columnas_fecha:
        if col in df_final.columns:
            no_nulos = df_final[col].notna().sum()
            if no_nulos > 0:
                ejemplo = df_final[col].dropna().iloc[0]
                logger.info(f"{col:<20}: {no_nulos:>5} valores | Ej: {ejemplo}")
    
    logger.info("\nCOLUMNAS CIS LIMPIAS (solo nÃºmeros):")
    columnas_cis_final = ["CIS_2"]
    for col in columnas_cis_final:
        if col in df_final.columns:
            valores = df_final[col].dropna()
            if len(valores) > 0:
                ejemplos_cis = valores.head(3).tolist()
                logger.info(f"{col:<20}: {len(valores):>5} valores | Ej: {ejemplos_cis}")
                # Verificar que solo tengan nÃºmeros
                todos_numeros = all(re.match(r'^\d+$', str(x)) for x in ejemplos_cis if pd.notna(x))
                logger.info(f"  âœ“ Solo nÃºmeros: {todos_numeros}")
    logger.info("=" * 60)

# =========================
# EJECUCIÃ“N
# =========================
if __name__ == "__main__":
    main()
