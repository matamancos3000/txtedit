import pandas as pd
import logging
from pathlib import Path
import unicodedata
import re

# =========================
# LOGGING
# =========================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

# =========================
# CONFIGURACIÃ“N
# =========================
BASE_PATH = Path("c:/Copia-reporte-Aclarabot")

ACLARABOT_PATH = next(BASE_PATH.glob("*.csv"))  # ej: 06-Jan.csv
ACLARAPP_PATH = BASE_PATH / "Copy-Aclarapp" / "TablaCopiadaDeAclarapp.csv"
AGENTES_PATH = BASE_PATH / "Copy-Aclarapp" / "InfoAgentes.csv"

OUTPUT_FILE = BASE_PATH / "Acumulado_filtrado_11-Dec.csv"

# =========================
# FUNCIONES
# =========================
def normalizar_columna(col):
    col = col.strip()
    col = unicodedata.normalize("NFKD", col)
    col = col.encode("ascii", "ignore").decode("utf-8")
    return col

def cargar_csv(ruta, sep=","):
    df = pd.read_csv(
        ruta,
        sep=sep,
        dtype=str,
        encoding="utf-8-sig",
        on_bad_lines="warn"
    )
    df.columns = [normalizar_columna(c) for c in df.columns]
    df = df.apply(lambda col: col.str.strip() if col.dtype == "object" else col)
    return df

def limpiar_formato_fecha_especial(valor):
    """
    Limpia formato especial: dd/MM/yyyy hh:mm:ss p. m. (con espacio entre p. y m.)
    y a. m.
    """
    if pd.isna(valor):
        return valor
    
    valor_str = str(valor).strip()
    
    if not valor_str or valor_str.lower() in ['nan', 'nat', 'null', 'none', '']:
        return valor
    
    # Corregir el espacio entre p. y m. / a. y m.
    valor_str = re.sub(r'p\.\s*m\.', 'PM', valor_str, flags=re.IGNORECASE)
    valor_str = re.sub(r'a\.\s*m\.', 'AM', valor_str, flags=re.IGNORECASE)
    
    # TambiÃ©n manejar sin puntos pero con espacio: "p m" o "a m"
    valor_str = re.sub(r'p\s+m', 'PM', valor_str, flags=re.IGNORECASE)
    valor_str = re.sub(r'a\s+m', 'AM', valor_str, flags=re.IGNORECASE)
    
    # Si todavÃ­a quedan puntos en AM/PM, quitarlos
    valor_str = re.sub(r'\bp\.m\.\b', 'PM', valor_str, flags=re.IGNORECASE)
    valor_str = re.sub(r'\ba\.m\.\b', 'AM', valor_str, flags=re.IGNORECASE)
    
    # Quitar espacios extra alrededor de AM/PM
    valor_str = re.sub(r'\s+([AP]M)\s*$', r' \1', valor_str)
    
    # Asegurar un solo espacio entre la hora y AM/PM
    valor_str = re.sub(r'(\d)\s+([AP]M)$', r'\1 \2', valor_str)
    
    return valor_str.strip()

def convertir_fecha_aclaraapp(valor):
    """
    FunciÃ³n especÃ­fica para convertir fechas de Aclarapp de formato 12h a 24h
    """
    if pd.isna(valor):
        return valor
    
    valor_str = str(valor).strip()
    
    if not valor_str or valor_str.lower() in ['nan', 'nat', 'null', 'none', '']:
        return valor
    
    # Primero aplicar la limpieza especial
    valor_limpio = limpiar_formato_fecha_especial(valor_str)
    
    try:
        # Intentar convertir de formato 12h a datetime
        fecha_dt = pd.to_datetime(
            valor_limpio,
            format="%d/%m/%Y %I:%M:%S %p",
            errors="raise"
        )
        
        # Convertir a string con formato de 24 horas
        return fecha_dt.strftime("%d/%m/%Y %H:%M:%S")
        
    except Exception as e:
        logger.warning(f"No se pudo convertir fecha Aclarapp: '{valor_str}' -> Error: {e}")
        
        # Si falla, intentar otros formatos
        try:
            # Intentar como datetime sin formato especÃ­fico
            fecha_dt = pd.to_datetime(valor_limpio, dayfirst=True, errors="coerce")
            if pd.notna(fecha_dt):
                return fecha_dt.strftime("%d/%m/%Y %H:%M:%S")
        except:
            pass
        
        # Si todo falla, devolver el valor original
        return valor_str

# =========================
# MAIN
# =========================
def main():
    logger.info("ðŸš€ Iniciando merge ACLARABOT + ACLARAPP + INFOAGENTES")

    # =========================
    # CARGA ARCHIVOS
    # =========================
    aclarabot_df = cargar_csv(ACLARABOT_PATH)
    logger.info(f"âœ“ Aclarabot cargado: {ACLARABOT_PATH.name} ({len(aclarabot_df)} filas)")
    
    if "Fecha" in aclarabot_df.columns:
        logger.info(f"ðŸ“‹ Ejemplos de formato 'Fecha' en Aclarabot (primeras 5):")
        for i in range(min(5, len(aclarabot_df))):
            fecha_ejemplo = aclarabot_df['Fecha'].iloc[i]
            logger.info(f"  Fila {i}: '{fecha_ejemplo}'")

    aclarapp_df = cargar_csv(ACLARAPP_PATH, sep="|")
    logger.info(f"âœ“ Aclarapp cargado ({len(aclarapp_df)} filas)")
    
    # =========================
    # CONVERTIR FECHAS DE ACLARAPP ANTES DEL MERGE
    # =========================
    logger.info("\nðŸ”„ CONVIRTIENDO FECHAS DE ACLARAPP A FORMATO 24 HORAS")
    
    columnas_fecha_aclaraapp = [
        "Fecha CreaciÃ³n", 
        "Fecha Enviado", 
        "Fecha Asignacion", 
        "Fecha Atendido"
    ]
    
    for col in columnas_fecha_aclaraapp:
        if col in aclarapp_df.columns:
            logger.info(f"Procesando columna Aclarapp: {col}")
            
            # Contar valores no nulos
            valores_no_nulos = aclarapp_df[col].notna().sum()
            logger.info(f"  Valores no nulos: {valores_no_nulos}")
            
            if valores_no_nulos > 0:
                # Mostrar ejemplos antes de la conversiÃ³n
                ejemplos_antes = aclarapp_df[col].dropna().head(3).tolist()
                logger.info(f"  Ejemplos ANTES de conversiÃ³n:")
                for i, ejemplo in enumerate(ejemplos_antes):
                    logger.info(f"    {i}: '{ejemplo}'")
                
                # Aplicar conversiÃ³n
                aclarapp_df[col] = aclarapp_df[col].apply(convertir_fecha_aclaraapp)
                
                # Mostrar ejemplos despuÃ©s de la conversiÃ³n
                ejemplos_despues = aclarapp_df[col].dropna().head(3).tolist()
                logger.info(f"  Ejemplos DESPUÃ‰S de conversiÃ³n:")
                for i, ejemplo in enumerate(ejemplos_despues):
                    logger.info(f"    {i}: '{ejemplo}'")
                
                # Verificar conversiÃ³n
                convertidos = aclarapp_df[col].dropna().count()
                logger.info(f"  âœ… Convertidos: {convertidos}/{valores_no_nulos}")

    agentes_df = cargar_csv(AGENTES_PATH, sep="|")
    logger.info(f"âœ“ InfoAgentes cargado ({len(agentes_df)} filas)")

    # =========================
    # AJUSTES DE COLUMNAS
    # =========================
    if "CIS" in aclarapp_df.columns:
        aclarapp_df.rename(columns={"CIS": "CIS_2"}, inplace=True)

    # =========================
    # MERGE 1: ACLARABOT + ACLARAPP
    # =========================
    merge_1 = aclarabot_df.merge(
        aclarapp_df,
        how="left",
        left_on="AclaracionID",
        right_on="ID Aclaracion",
        suffixes=("", "_DUP"),
        indicator=True
    )

    logger.info(f"Merge Aclarapp: {merge_1['_merge'].value_counts().to_dict()}")
    merge_1.drop(columns=["_merge"], inplace=True)

    # =========================
    # MERGE 2: + INFOAGENTES
    # =========================
    df_final = merge_1.merge(
        agentes_df,
        how="left",
        left_on="Numero de registro",
        right_on="ID",
        suffixes=("", "_AGENTE"),
        indicator=True
    )

    logger.info(f"Merge Agentes: {df_final['_merge'].value_counts().to_dict()}")
    df_final.drop(columns=["_merge"], inplace=True)

    # =========================
    # NORMALIZAR COLUMNA FECHA PRINCIPAL (de Aclarabot)
    # =========================
    logger.info("\nðŸ”„ Normalizando columna 'Fecha' (de Aclarabot)...")
    
    if "Fecha" in df_final.columns:
        logger.info(f"Procesando columna: Fecha")
        
        valores_originales = df_final["Fecha"].notna().sum()
        logger.info(f"  Valores no nulos originales: {valores_originales}")
        
        if valores_originales > 0:
            # Mostrar ejemplos originales
            ejemplos = df_final["Fecha"].dropna().head(3).tolist()
            logger.info(f"  Ejemplos originales:")
            for i, ejemplo in enumerate(ejemplos):
                logger.info(f"    {i}: '{ejemplo}'")
        
        # Aplicar limpieza y conversiÃ³n
        df_final["Fecha"] = df_final["Fecha"].apply(limpiar_formato_fecha_especial)
        
        # Convertir a datetime
        df_final["Fecha"] = pd.to_datetime(
            df_final["Fecha"],
            format="%d/%m/%Y %I:%M:%S %p",
            dayfirst=True,
            errors="coerce"
        )
        
        # Verificar conversiÃ³n
        convertidos = df_final["Fecha"].notna().sum()
        logger.info(f"  âœ… Fechas convertidas: {convertidos}/{valores_originales}")
        
        if convertidos > 0:
            # Mostrar ejemplos despuÃ©s de conversiÃ³n
            ejemplos_dt = df_final["Fecha"].dropna().head(3).tolist()
            logger.info(f"  Ejemplos como datetime:")
            for i, ejemplo in enumerate(ejemplos_dt):
                logger.info(f"    {i}: {ejemplo}")

    # =========================
    # ORDENAR POR FECHA (de mÃ¡s antigua a mÃ¡s actual)
    # =========================
    if "Fecha" in df_final.columns:
        logger.info(f"\nðŸ“Š Ordenando por columna 'Fecha' (de mÃ¡s antigua a mÃ¡s actual)")
        
        fechas_validas = df_final["Fecha"].notna().sum()
        logger.info(f"  Fechas vÃ¡lidas para ordenar: {fechas_validas}/{len(df_final)}")
        
        if fechas_validas > 0:
            fecha_min = df_final["Fecha"].min()
            fecha_max = df_final["Fecha"].max()
            logger.info(f"  Rango de fechas: {fecha_min} a {fecha_max}")
            
            df_final.sort_values("Fecha", inplace=True, na_position="last")
            
            primera_fecha = df_final["Fecha"].iloc[0] if fechas_validas > 0 else None
            ultima_fecha_valida = df_final["Fecha"].iloc[fechas_validas-1] if fechas_validas > 0 else None
            
            logger.info(f"  Primera fecha despuÃ©s de ordenar: {primera_fecha}")
            logger.info(f"  Ãšltima fecha vÃ¡lida: {ultima_fecha_valida}")
        else:
            logger.warning("  âš ï¸ No hay fechas vÃ¡lidas para ordenar")
    else:
        logger.warning("âš ï¸ No se encontrÃ³ columna 'Fecha' para ordenar")

    # =========================
    # FORMATEAR TODAS LAS FECHAS PARA SALIDA
    # =========================
    logger.info("\nðŸ’¾ Formateando TODAS las fechas para salida CSV...")
    
    todas_columnas_fecha = [
        "Fecha", 
        "Fecha CreaciÃ³n", 
        "Fecha Enviado", 
        "Fecha Asignacion", 
        "Fecha Atendido"
    ]
    
    for col in todas_columnas_fecha:
        if col in df_final.columns:
            # Para la columna Fecha (de Aclarabot) que estÃ¡ como datetime
            if col == "Fecha":
                mask = df_final[col].notna()
                count_format = mask.sum()
                if count_format > 0:
                    df_final.loc[mask, col] = df_final.loc[mask, col].dt.strftime("%d/%m/%Y %H:%M:%S")
                    logger.info(f"  {col}: {count_format} fechas formateadas a dd/MM/YYYY HH:MM:SS")
            
            # Para las columnas de Aclarapp (ya convertidas)
            else:
                # Verificar que tienen el formato correcto
                valores_no_nulos = df_final[col].notna().sum()
                if valores_no_nulos > 0:
                    logger.info(f"  {col}: {valores_no_nulos} valores (ya en formato 24h)")
                    
                    # Verificar que estÃ©n en el formato correcto
                    ejemplos = df_final[col].dropna().head(3).tolist()
                    for i, ejemplo in enumerate(ejemplos):
                        if isinstance(ejemplo, str):
                            logger.info(f"    Ejemplo {i}: '{ejemplo}'")
                            # Verificar formato
                            if re.match(r'\d{2}/\d{2}/\d{4} \d{2}:\d{2}:\d{2}', ejemplo):
                                logger.info(f"      âœ“ Formato 24h correcto")
                            else:
                                logger.warning(f"      âš ï¸ Formato diferente: {ejemplo}")

    # =========================
    # EXPORTAR CSV
    # =========================
    logger.info(f"\nðŸ“¤ Exportando a CSV: {OUTPUT_FILE}")
    df_final.to_csv(
        OUTPUT_FILE,
        index=False,
        encoding="utf-8-sig"
    )

    logger.info("âœ… Archivo generado correctamente")
    logger.info(f"ðŸ“„ UbicaciÃ³n: {OUTPUT_FILE}")
    logger.info(f"ðŸ“Š Total filas: {len(df_final)}")
    
    # Resumen final
    logger.info("\nðŸ“Š RESUMEN FINAL DE FECHAS:")
    logger.info("=" * 50)
    for col in todas_columnas_fecha:
        if col in df_final.columns:
            no_nulos = df_final[col].notna().sum()
            if no_nulos > 0:
                ejemplo = df_final[col].dropna().iloc[0]
                logger.info(f"{col:<20}: {no_nulos:>5} valores | Ejemplo: '{ejemplo}'")
            else:
                logger.info(f"{col:<20}: {no_nulos:>5} valores")
    logger.info("=" * 50)

# =========================
# EJECUCIÃ“N
# =========================
if __name__ == "__main__":
    main()
