import os
import pandas as pd
import re
from datetime import datetime, timedelta
from openpyxl import load_workbook
from openpyxl.styles import Font, PatternFill, Alignment
from openpyxl.chart import BarChart, LineChart, Reference, Series
from openpyxl.chart.marker import DataPoint

# === CONFIGURACI√ìN MEJORADA ===
INPUT_FOLDER = r"C:\Logs-Reporttoken"
OUTPUT_FOLDER = r"C:\Logs-Reporttoken\Procesados"
HTML_FOLDER = r"C:\Logs-Reporttoken\HTML_CORREO"
ENVIAR_CORREO = True  # <<< Cambia a False si NO quieres enviar correo

# Crear carpetas de salida si no existen
os.makedirs(OUTPUT_FOLDER, exist_ok=True)
os.makedirs(HTML_FOLDER, exist_ok=True)

# === CONSTANTES ===
COLUMNAS_NECESARIAS = ["CreatedOn", "FECHA DE TRABAJO", "FECHA DE NACIMIENTO", "DETALLES"]
ORDEN_INTERVALOS = [
    "menos de 10 minutos", "de 11 a 20 minutos",
    "de 21 a 30 minutos", "de 30 a 60 minutos",
    "m√°s de 60 minutos", "Horario bot inactivo"
]

COLORES_INTERVALOS = {
    "menos de 10 minutos": "#00FF00",    # verde
    "de 11 a 20 minutos": "#90EE90",     # verde claro
    "de 21 a 30 minutos": "#FFFF00",     # amarillo
    "de 30 a 60 minutos": "#FFA500",     # naranja
    "m√°s de 60 minutos": "#FF0000",      # rojo
    "Horario bot inactivo": "#000000",   # negro
    "Total": "#808080"                   # gris
}

# === FUNCIONES AUXILIARES MEJORADAS ===
def parse_fecha_trabajo(valor):
    """Parsea fechas de trabajo con m√∫ltiples formatos"""
    if pd.isna(valor):
        return None
    
    valor_str = str(valor).strip()
    formatos = ("%d/%m/%Y %H:%M:%S", "%d/%m/%Y %H:%M", "%Y-%m-%d %H:%M:%S")
    
    for fmt in formatos:
        try:
            return datetime.strptime(valor_str, fmt)
        except ValueError:
            continue
    return None

def parse_fecha_nac(valor):
    """Parsea fechas de nacimiento con manejo de AM/PM"""
    if pd.isna(valor):
        return None
    
    valor_str = str(valor).lower().replace("a. m.", "AM").replace("p. m.", "PM").strip()
    formatos = ("%d/%m/%Y %I:%M:%S %p", "%d/%m/%Y %I:%M %p", "%d/%m/%Y", "%Y-%m-%d")
    
    for fmt in formatos:
        try:
            return datetime.strptime(valor_str, fmt)
        except ValueError:
            continue
    return None

def calcular_minutos(row):
    """Calcula minutos entre creaci√≥n y trabajo"""
    created, trabajado = row.get("CreatedOn"), row.get("FECHA DE TRABAJO")
    
    if pd.isna(created) or trabajado is None:
        return None
    
    # Verificar horario bot inactivo (22:00 - 06:00)
    if created.hour >= 22 or created.hour < 6:
        return "Horario bot inactivo"
    
    # Calcular diferencia en minutos
    diferencia = (trabajado - created).total_seconds() / 60
    return round(diferencia) if diferencia >= 0 else None

def clasificar_intervalo(valor):
    """Clasifica el tiempo de respuesta en intervalos"""
    if isinstance(valor, str):
        return valor
    if pd.isna(valor) or valor is None:
        return "Sin dato"
    
    if valor <= 10:
        return "menos de 10 minutos"
    elif valor <= 20:
        return "de 11 a 20 minutos"
    elif valor <= 30:
        return "de 21 a 30 minutos"
    elif valor <= 60:
        return "de 30 a 60 minutos"
    else:
        return "m√°s de 60 minutos"

def limpiar_detalles(texto):
    """Limpia y categoriza los textos de detalles"""
    if not isinstance(texto, str):
        return "Error de sistema"
    
    texto = texto.strip()
    if not texto:
        return "Error de sistema"
    
    # Patrones de categorizaci√≥n
    patrones = [
        (r"^El restablecimiento fuera de l√≠nea no se pudo completar por estado: 'Aprobado'", "Aprobado por otro medio"),
        (r"^El restablecimiento fuera de l√≠nea no se pudo completar por estado:", "No tiene Solicitud vigente"),
        (r"Error de sistema", "Error de sistema"),
        (r"^Productos y Servicios.*", "Error en obtener registro por voz")
    ]
    
    for patron, categoria in patrones:
        if re.search(patron, texto, re.IGNORECASE):
            return categoria
    
    return texto

def mostrar_progreso(paso, total_pasos, archivo, mensaje=""):
    """Muestra el progreso del procesamiento"""
    porcentaje = round((paso / total_pasos) * 100, 2)
    mensaje_extra = f" - {mensaje}" if mensaje else ""
    print(f"   üìÇ Procesando {archivo}... {porcentaje}%{mensaje_extra}")

def validar_archivo(df, archivo):
    """Valida que el archivo tenga las columnas necesarias"""
    for col in COLUMNAS_NECESARIAS:
        if col not in df.columns:
            raise ValueError(f"‚ùå Falta la columna requerida '{col}' en {archivo}")

def procesar_dataframe(df):
    """Procesa el dataframe y realiza todos los c√°lculos"""
    # Parsear fechas
    df["CreatedOn"] = pd.to_datetime(df["CreatedOn"], format="%b %d %Y %I:%M%p", errors="coerce") + timedelta(hours=6)
    df["FECHA DE TRABAJO"] = df["FECHA DE TRABAJO"].apply(parse_fecha_trabajo)
    df["FECHA DE NACIMIENTO"] = df["FECHA DE NACIMIENTO"].apply(parse_fecha_nac)
    
    # C√°lculos
    df["Minutos de respuesta"] = df.apply(calcular_minutos, axis=1)
    df["Intervalo"] = df["Minutos de respuesta"].apply(clasificar_intervalo)
    df["DETALLES"] = df["DETALLES"].apply(limpiar_detalles)
    df["Fecha"] = df["CreatedOn"].dt.date
    
    # Ordenar por fecha de creaci√≥n
    return df.sort_values(by="CreatedOn", ascending=True)

def generar_resumenes(df):
    """Genera todos los res√∫menes necesarios"""
    # Resumen por d√≠a + intervalo (pivot table)
    pivot = pd.pivot_table(
        df,
        index="Fecha",
        columns="Intervalo",
        values="MSISDN",
        aggfunc="count",
        fill_value=0
    )
    
    # Asegurar todos los intervalos
    for intervalo in ORDEN_INTERVALOS:
        if intervalo not in pivot.columns:
            pivot[intervalo] = 0
    
    pivot = pivot.reindex(columns=ORDEN_INTERVALOS, fill_value=0)
    pivot["Total"] = pivot.sum(axis=1)
    pivot = pivot.sort_index(ascending=True)
    
    # Resumen por detalles
    resumen_detalles = df["DETALLES"].value_counts().reset_index()
    resumen_detalles.columns = ["DETALLES", "Cantidad"]
    
    # Top MSISDN
    top_msisdn = df["MSISDN"].value_counts().head(18).reset_index()
    top_msisdn.columns = ["MSISDN", "Cantidad"]
    
    return pivot, resumen_detalles, top_msisdn

def aplicar_formato_excel(wb, pivot):
    """Aplica formato al archivo Excel"""
    ws_logs = wb["Logs"]
    ws_resumen = wb["Resumen"]
    
    # Formato encabezados
    header_fill = PatternFill(start_color="FF0000", end_color="FF0000", fill_type="solid")
    header_font = Font(bold=True, color="FFFFFF")
    
    for ws in [ws_logs, ws_resumen]:
        for cell in ws[1]:
            cell.font = header_font
            cell.fill = header_fill
    
    # Formato columna A de resumen
    for cell in ws_resumen["A"]:
        cell.alignment = Alignment(horizontal="left")
    ws_resumen.column_dimensions["A"].width = 18
    
    return ws_resumen, pivot.shape

def aplicar_formato_tablas_resumen(ws_resumen, pivot_shape, forma_detalles, forma_msisdn):
    """Aplica formato a las tablas de DETALLES y MSISDN en el resumen"""
    fila_inicio = pivot_shape[0] + 4
    ancho_detalles = forma_detalles[1]  # n√∫mero de columnas de detalles
    
    # Formato para encabezados (fondo rojo, letras blancas)
    header_fill = PatternFill(start_color="FF0000", end_color="FF0000", fill_type="solid")
    header_font = Font(bold=True, color="FFFFFF")
    header_alignment = Alignment(horizontal="center", vertical="center")
    
    # üîπ Formatear tabla de DETALLES (izquierda)
    for col in range(1, ancho_detalles + 1):  # Columnas A, B, etc.
        cell = ws_resumen.cell(row=fila_inicio, column=col)
        cell.fill = header_fill
        cell.font = header_font
        cell.alignment = header_alignment
    
    # üîπ Formatear tabla de MSISDN (derecha, con 2 columnas de separaci√≥n)
    col_inicio_msisdn = ancho_detalles + 3  # +2 por las columnas de datos +1 de separaci√≥n
    for col in range(col_inicio_msisdn, col_inicio_msisdn + 2):  # MSISDN y Cantidad
        cell = ws_resumen.cell(row=fila_inicio, column=col)
        cell.fill = header_fill
        cell.font = header_font
        cell.alignment = header_alignment
    
    # Ajustar anchos de columnas para mejor visualizaci√≥n
    ws_resumen.column_dimensions['A'].width = 18  # Fecha del pivot
    ws_resumen.column_dimensions['B'].width = 12  # Primera columna del pivot
    
    # Para la tabla de DETALLES
    ws_resumen.column_dimensions['A'].width = 40  # Columna A de detalles (DETALLES)
    ws_resumen.column_dimensions['B'].width = 12  # Columna B de detalles (Cantidad)
    
    # Para la tabla de MSISDN (saltando 2 columnas de separaci√≥n)
    letra_col_msisdn = chr(64 + col_inicio_msisdn)
    letra_col_cantidad = chr(64 + col_inicio_msisdn + 1)
    
    ws_resumen.column_dimensions[letra_col_msisdn].width = 20    # Columna MSISDN
    ws_resumen.column_dimensions[letra_col_cantidad].width = 12  # Columna Cantidad MSISDN
    
    # Agregar t√≠tulos a las tablas
    ws_resumen.cell(row=fila_inicio-1, column=1, value="DETALLES - RESUMEN").font = Font(bold=True, size=12)
    ws_resumen.cell(row=fila_inicio-1, column=col_inicio_msisdn, value="TOP MSISDN").font = Font(bold=True, size=12)

def crear_grafico(ws_resumen, pivot_shape):
    """Crea el gr√°fico combinado de barras y l√≠neas"""
    max_row = pivot_shape[0] + 1
    max_col = pivot_shape[1] + 1
    
    # Gr√°fico de barras para intervalos
    chart = BarChart()
    data = Reference(ws_resumen, min_col=2, max_col=max_col-1, min_row=1, max_row=max_row)
    cats = Reference(ws_resumen, min_col=1, min_row=2, max_row=max_row)
    
    chart.add_data(data, titles_from_data=True)
    chart.set_categories(cats)
    
    # L√≠nea para totales
    line_chart = LineChart()
    total_data = Reference(ws_resumen, min_col=max_col, max_col=max_col, min_row=1, max_row=max_row)
    line_chart.add_data(total_data, titles_from_data=True)
    
    # Combinar gr√°ficos
    chart += line_chart
    chart.title = "Distribuci√≥n por Intervalos (diario)"
    chart.y_axis.title = "Cantidad"
    chart.x_axis.title = "Fecha"
    chart.width = 34
    chart.height = 17
    
    # üîß SOLUCI√ìN DEFINITIVA: Colores por posici√≥n (m√°s estable)
    colores_series = [
        "00FF00",    # verde - menos de 10 minutos
        "90EE90",    # verde claro - de 11 a 20 minutos  
        "FFFF00",    # amarillo - de 21 a 30 minutos
        "FFA500",    # naranja - de 30 a 60 minutos
        "FF0000",    # rojo - m√°s de 60 minutos
        "000000",    # negro - Horario bot inactivo
        "808080"     # gris - Total
    ]
    
    # Aplicar colores
    for i, serie in enumerate(chart.series):
        if i < len(colores_series):
            color = colores_series[i]
            try:
                serie.graphicalProperties.solidFill = color
                # Para la l√≠nea (√∫ltima serie)
                if i == len(chart.series) - 1:
                    serie.graphicalProperties.line.solidFill = color
            except Exception as e:
                print(f"‚ö†Ô∏è  No se pudo aplicar color a la serie {i}: {e}")
    
    return chart

def generar_html_correo(pivot, resumen_detalles, top_msisdn, archivo_original):
    """Genera un archivo HTML optimizado para correo electr√≥nico"""
    
    # Calcular estad√≠sticas generales
    total_registros = pivot["Total"].sum()
    promedio_diario = pivot["Total"].mean()
    
    # Fechas del reporte
    fecha_inicio = pivot.index.min()
    fecha_fin = pivot.index.max()
    
    # Calcular porcentajes por intervalo
    total_por_intervalo = pivot[ORDEN_INTERVALOS].sum()
    porcentajes = (total_por_intervalo / total_registros * 100).round(1)
    
    # Crear el contenido HTML
    html_content = f"""
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Logs - {archivo_original}</title>
    <style>
        body {{
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }}
        .header {{
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 30px;
        }}
        .stats-container {{
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }}
        .stat-card {{
            flex: 1;
            min-width: 200px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }}
        .stat-value {{
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }}
        .stat-label {{
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }}
        .table-container {{
            margin-bottom: 30px;
            overflow-x: auto;
        }}
        table {{
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }}
        th {{
            background-color: #dc3545;
            color: white;
            padding: 12px;
            text-align: left;
        }}
        td {{
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }}
        tr:hover {{
            background-color: #f5f5f5;
        }}
        .intervalo-cell {{
            font-weight: bold;
            padding-left: 15px;
            position: relative;
        }}
        .intervalo-cell::before {{
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }}
        .intervalo-verde::before {{ background-color: #00FF00; }}
        .intervalo-verde-claro::before {{ background-color: #90EE90; }}
        .intervalo-amarillo::before {{ background-color: #FFFF00; }}
        .intervalo-naranja::before {{ background-color: #FFA500; }}
        .intervalo-rojo::before {{ background-color: #FF0000; }}
        .intervalo-negro::before {{ background-color: #000000; }}
        .percentage-bar {{
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            margin-top: 5px;
            overflow: hidden;
        }}
        .percentage-fill {{
            height: 100%;
            border-radius: 10px;
        }}
        .badge {{
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }}
        .badge-success {{ background-color: #28a745; color: white; }}
        .badge-warning {{ background-color: #ffc107; color: black; }}
        .badge-danger {{ background-color: #dc3545; color: white; }}
        .badge-secondary {{ background-color: #6c757d; color: white; }}
        .section-title {{
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }}
        .two-columns {{
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }}
        .column {{
            flex: 1;
        }}
        @media (max-width: 768px) {{
            .two-columns {{
                flex-direction: column;
            }}
            .stats-container {{
                flex-direction: column;
            }}
        }}
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Reporte de Logs - Bot de Automatizaci√≥n</h1>
        <p>Per√≠odo: {fecha_inicio} al {fecha_fin}</p>
        <p>Archivo origen: {archivo_original}</p>
    </div>
    
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-value">{total_registros:,}</div>
            <div class="stat-label">Total de Registros</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{promedio_diario:.1f}</div>
            <div class="stat-label">Promedio Diario</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{pivot.shape[0]}</div>
            <div class="stat-label">D√≠as Analizados</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{len(resumen_detalles)}</div>
            <div class="stat-label">Categor√≠as de Error</div>
        </div>
    </div>
    
    <div class="section-title">üìà Distribuci√≥n por Tiempo de Respuesta</div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Intervalo de Tiempo</th>
                    <th>Cantidad</th>
                    <th>Porcentaje</th>
                    <th>Distribuci√≥n</th>
                </tr>
            </thead>
            <tbody>
"""
    
    # Agregar filas para cada intervalo
    for intervalo in ORDEN_INTERVALOS:
        cantidad = total_por_intervalo[intervalo]
        porcentaje = porcentajes[intervalo]
        color_class = intervalo.replace(" ", "-").replace("√≥", "o").lower()
        
        html_content += f"""
                <tr>
                    <td class="intervalo-cell intervalo-{color_class}">{intervalo.title()}</td>
                    <td><strong>{cantidad:,}</strong></td>
                    <td>{porcentaje}%</td>
                    <td>
                        <div class="percentage-bar">
                            <div class="percentage-fill" style="width: {porcentaje}%; background-color: {COLORES_INTERVALOS[intervalo]};"></div>
                        </div>
                    </td>
                </tr>
"""
    
    # Fila de total
    html_content += f"""
                <tr style="background-color: #f8f9fa; font-weight: bold;">
                    <td>TOTAL</td>
                    <td>{total_registros:,}</td>
                    <td>100%</td>
                    <td>
                        <div class="percentage-bar">
                            <div class="percentage-fill" style="width: 100%; background-color: {COLORES_INTERVALOS['Total']};"></div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="two-columns">
        <div class="column">
            <div class="section-title">üîç Resumen por Detalles</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Categor√≠a</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody>
"""
    
    # Agregar filas de detalles
    for _, row in resumen_detalles.head(10).iterrows():
        categoria = row['DETALLES']
        cantidad = row['Cantidad']
        porcentaje_detalle = (cantidad / total_registros * 100)
        
        # Determinar el badge seg√∫n la categor√≠a
        if "Error" in categoria:
            badge = '<span class="badge badge-danger">Error</span>'
        elif "Aprobado" in categoria:
            badge = '<span class="badge badge-success">√âxito</span>'
        elif "Solicitud" in categoria:
            badge = '<span class="badge badge-warning">Validaci√≥n</span>'
        else:
            badge = '<span class="badge badge-secondary">Otro</span>'
        
        html_content += f"""
                        <tr>
                            <td>{badge} {categoria}</td>
                            <td><strong>{cantidad:,}</strong> ({porcentaje_detalle:.1f}%)</td>
                        </tr>
"""
    
    html_content += """
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="column">
            <div class="section-title">üì± Top MSISDN</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>MSISDN</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody>
"""
    
    # Agregar filas de MSISDN
    for _, row in top_msisdn.iterrows():
        msisdn = row['MSISDN']
        cantidad = row['Cantidad']
        
        # Determinar el badge seg√∫n la cantidad
        if cantidad > 10:
            badge = '<span class="badge badge-danger">Alto</span>'
        elif cantidad > 5:
            badge = '<span class="badge badge-warning">Medio</span>'
        else:
            badge = '<span class="badge badge-success">Bajo</span>'
        
        html_content += f"""
                        <tr>
                            <td>{badge} {msisdn}</td>
                            <td><strong>{cantidad:,}</strong></td>
                        </tr>
"""
    
    html_content += """
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="section-title">üìÖ Resumen Diario</div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
"""
    
    # Encabezados de intervalos
    for intervalo in ORDEN_INTERVALOS:
        html_content += f'                    <th>{intervalo.title()}</th>\n'
    
    html_content += f'                    <th>Total</th>\n'
    html_content += '                </tr>\n            </thead>\n            <tbody>\n'
    
    # Agregar filas de resumen diario (√∫ltimos 7 d√≠as o todos si son menos)
    dias_mostrar = min(7, len(pivot))
    for fecha in pivot.tail(dias_mostrar).index:
        html_content += f'                <tr>\n                    <td><strong>{fecha}</strong></td>\n'
        
        for intervalo in ORDEN_INTERVALOS:
            valor = pivot.loc[fecha, intervalo]
            html_content += f'                    <td>{valor:,}</td>\n'
        
        total_dia = pivot.loc[fecha, "Total"]
        html_content += f'                    <td><strong>{total_dia:,}</strong></td>\n'
        html_content += '                </tr>\n'
    
    html_content += """
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 40px; padding: 20px; background-color: #f8f9fa; border-radius: 5px; font-size: 14px; color: #6c757d;">
        <p><strong>üìã Informaci√≥n del Reporte:</strong></p>
        <p>‚Ä¢ <strong>Menos de 10 minutos:</strong> Respuesta √≥ptima (verde)</p>
        <p>‚Ä¢ <strong>11-20 minutos:</strong> Respuesta aceptable (verde claro)</p>
        <p>‚Ä¢ <strong>21-30 minutos:</strong> Respuesta regular (amarillo)</p>
        <p>‚Ä¢ <strong>30-60 minutos:</strong> Respuesta lenta (naranja)</p>
        <p>‚Ä¢ <strong>M√°s de 60 minutos:</strong> Respuesta cr√≠tica (rojo)</p>
        <p>‚Ä¢ <strong>Horario bot inactivo:</strong> Solicitudes entre 22:00-06:00 (negro)</p>
        <p><em>Reporte generado autom√°ticamente el {datetime.now().strftime("%d/%m/%Y %H:%M:%S")}</em></p>
    </div>
</body>
</html>
"""
    
    # Guardar el archivo HTML
    html_filename = os.path.join(HTML_FOLDER, "bodymail.html")
    with open(html_filename, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"‚úÖ Archivo HTML generado: {html_filename}")
    return html_filename

# === PROCESAMIENTO PRINCIPAL ===
def main():
    """Funci√≥n principal de procesamiento"""
    archivos = [f for f in os.listdir(INPUT_FOLDER) if f.lower().endswith(".csv")]
    total_archivos = len(archivos)
    
    if total_archivos == 0:
        print("‚ùå No se encontraron archivos CSV en la carpeta de entrada")
        return
    
    print(f"üìÅ Encontrados {total_archivos} archivos CSV para procesar\n")
    
    for idx, archivo in enumerate(archivos, start=1):
        try:
            procesar_archivo(archivo, idx, total_archivos)
        except Exception as e:
            print(f"‚ùå Error procesando {archivo}: {str(e)}")
            continue

def procesar_archivo(archivo, idx, total):
    """Procesa un archivo individual"""
    porcentaje = round((idx / total) * 100, 2)
    print(f"üîÑ Procesando {archivo}... ({idx}/{total}, {porcentaje}%)")
    
    # Rutas de archivos
    input_path = os.path.join(INPUT_FOLDER, archivo)
    output_path = os.path.join(OUTPUT_FOLDER, archivo.replace(".csv", "-procesado.xlsx"))
    
    # Leer y validar archivo
    df = pd.read_csv(input_path, encoding="utf-8-sig", dtype={"MSISDN": str})
    validar_archivo(df, archivo)
    
    # Procesar datos
    df = procesar_dataframe(df)
    pivot, resumen_detalles, top_msisdn = generar_resumenes(df)
    
    # ‚úÖ GENERAR HTML PARA CORREO
    print("üìß Generando HTML para correo electr√≥nico...")
    generar_html_correo(pivot, resumen_detalles, top_msisdn, archivo)
    
    # Exportar a Excel
    PASOS_TOTALES = 6
    paso_actual = 1
    
    with pd.ExcelWriter(output_path, engine="openpyxl",
                        date_format="DD/MM/YYYY HH:MM:SS",
                        datetime_format="DD/MM/YYYY HH:MM:SS") as writer:
        
        df.to_excel(writer, sheet_name="Logs", index=False)
        paso_actual += 1
        mostrar_progreso(paso_actual, PASOS_TOTALES, archivo, "Exportando datos...")
        
        pivot.to_excel(writer, sheet_name="Resumen", startrow=0, index=True)
        paso_actual += 1
        mostrar_progreso(paso_actual, PASOS_TOTALES, archivo, "Generando resumen...")
        
        # üìä NUEVA POSICI√ìN: DETALLES a la izquierda, MSISDN a la derecha
        # Calcular posici√≥n despu√©s del pivot
        fila_inicio = pivot.shape[0] + 4
        
        # Escribir tabla de DETALLES (izquierda)
        resumen_detalles.to_excel(writer, sheet_name="Resumen", 
                                startrow=fila_inicio, startcol=0, index=False)
        
        # Escribir tabla de MSISDN (derecha) - con 2 columnas de separaci√≥n
        top_msisdn.to_excel(writer, sheet_name="Resumen", 
                          startrow=fila_inicio, startcol=resumen_detalles.shape[1] + 2, index=False)
    
    # Aplicar formato y gr√°ficos
    wb = load_workbook(output_path)
    ws_resumen, pivot_shape = aplicar_formato_excel(wb, pivot)
    
    # Aplicar formato a las nuevas tablas
    aplicar_formato_tablas_resumen(ws_resumen, pivot_shape, resumen_detalles.shape, top_msisdn.shape)
    
    chart = crear_grafico(ws_resumen, pivot_shape)
    ws_resumen.add_chart(chart, "I2")
    
    wb.save(output_path)
    print(f"‚úÖ Archivo Excel generado: {output_path}\n")

if __name__ == "__main__":
    main()
