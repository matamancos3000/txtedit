#!/usr/bin/env python3
"""
Reporte de Logs Aclarabot y Aclarapp
Genera combinaci√≥n de logs Aclarabot (DEV, UAT, PROD) limitando a 12 columnas
y procesa un archivo local de Aclarapp limitando a 13 columnas.

Variables configurables al inicio del archivo para hacerlo din√°mico.
Muestra emojis en consola y crea carpetas si no existen.
"""

from pathlib import Path
import pandas as pd
import datetime
import os

# ----------------------
# CONFIGURACI√ìN
# ----------------------

BASE_ACLARABOT = Path(r"C:/Carpeta/Aclarabot")  
ACLARAPP_COPY_PATH = Path(r"C:/Copia-reporte-Aclarabot/Copy-Aclarapp/TablaCopiadaDeAclarapp.csv")
OUTPUT_BASE = Path(r"C:/Copia-reporte-Aclarabot")

ENTORNOS = ["DEV", "UAT", "PROD"]

# ahora el nombre puede ser Log.csv o log.csv
ACLARABOT_FILENAMES = ["Log.csv", "log.csv"]

ACLARABOT_MAX_COLS = 12
ACLARAPP_MAX_COLS = 13
GENERATE_LOGFILE = True

# ----------------------
# FUNCIONES
# ----------------------

def emoji(msg, em="üî∑"):
    print(f"{em} {msg}")

def ensure_dir(path: Path):
    if not path.exists():
        path.mkdir(parents=True, exist_ok=True)
        emoji(f"Carpeta creada: {path}", "üìÅ")
    else:
        emoji(f"Carpeta existente: {path}", "üìÇ")


def delete_old_csvs(base: Path):
    """Elimina todos los CSV directamente dentro de OUTPUT_BASE (no subcarpetas)."""
    emoji("Eliminando archivos CSV antiguos‚Ä¶", "üóëÔ∏è")
    count = 0
    for f in base.glob("*.csv"):
        try:
            f.unlink()
            count += 1
            emoji(f"Eliminado: {f}", "‚ùå")
        except Exception as e:
            emoji(f"No se pudo eliminar {f}: {e}", "‚ö†Ô∏è")
    emoji(f"Total de CSV eliminados: {count}", "‚úîÔ∏è")


def read_csv_limited(path: Path, max_cols: int, sep=None):
    if not path.exists():
        emoji(f"Archivo no encontrado: {path}", "‚ö†Ô∏è")
        return pd.DataFrame()

    try:
        df = pd.read_csv(path, sep=sep, engine='python', dtype=str, keep_default_na=False)
        if df.shape[1] > max_cols:
            df = df.iloc[:, :max_cols].copy()
        return df
    except Exception:
        try:
            df = pd.read_csv(path, sep=",", engine='python', dtype=str, keep_default_na=False)
            if df.shape[1] > max_cols:
                df = df.iloc[:, :max_cols].copy()
            return df
        except Exception:
            emoji(f"Fallo al leer archivo: {path}", "‚ùå")
            return pd.DataFrame()


def find_aclarabot_file(path: Path):
    """Busca Log.csv o log.csv en orden."""
    for name in ACLARABOT_FILENAMES:
        file_path = path / name
        if file_path.exists():
            return file_path
    return None


def combine_aclarabot(base_path: Path, entornos: list, year: int, month: int, out_folder: Path):
    frames = []
    for entorno in entornos:
        base_folder = base_path / entorno / "Log" / f"{year}" / f"{month:02d}"
        ruta = find_aclarabot_file(base_folder)

        if ruta:
            emoji(f"Encontrado log en {entorno}: {ruta}", "üîç")
            df = read_csv_limited(ruta, ACLARABOT_MAX_COLS)
            df.insert(0, "ENTORNO", entorno)
            frames.append(df)
        else:
            emoji(f"No se encontr√≥ Log para {entorno}", "‚ö†Ô∏è")

    if not frames:
        emoji("No hay datos v√°lidos para combinar.", "‚ö†Ô∏è")
        return None

    combined = pd.concat(frames, ignore_index=True)
    out_path = out_folder / "Aclarabot_combinado.csv"
    combined.to_csv(out_path, index=False)
    emoji(f"Aclarabot combinado guardado en: {out_path}", "üíæ")

    return out_path


def process_aclarapp(aclarapp_path: Path, out_folder: Path):
    emoji(f"Procesando Aclarapp: {aclarapp_path}", "üìÑ")
    df = read_csv_limited(aclarapp_path, ACLARAPP_MAX_COLS)
    if df.empty:
        emoji("Archivo Aclarapp no encontrado o vac√≠o.", "‚ö†Ô∏è")
        return None

    out_path = out_folder / "Aclarapp_limpio.csv"
    df.to_csv(out_path, index=False)
    emoji(f"Aclarapp limpio guardado en: {out_path}", "üíæ")

    return out_path


# ----------------------
# MAIN
# ----------------------

def main():
    hoy = datetime.date.today()
    carpeta_diaria = OUTPUT_BASE / hoy.strftime("%Y-%m-%d")

    # Crear carpeta diaria
    ensure_dir(carpeta_diaria)

    # üî• Nuevo: borrar CSV viejos antes de procesar
    delete_old_csvs(OUTPUT_BASE)

    combine_aclarabot(BASE_ACLARABOT, ENTORNOS, hoy.year, hoy.month, carpeta_diaria)
    process_aclarapp(ACLARAPP_COPY_PATH, carpeta_diaria)

    emoji("Proceso completado ‚úÖ", "‚úÖ")


if __name__ == "__main__":
    main()
