import os, pandas as pd
from datetime import datetime
import chardet

# Configuraci√≥n
RUTA_BASE = "../Carpeta/Aclarabot"
DESTINO = "c:/Copia-reporte-Aclarabot"
ACLARAPP = "c:/Copia-reporte-Aclarabot/Copy-Aclarapp/TablaCopiadaDeAclarapp.csv"
ENTORNOS = ["DEV", "UAT", "PROD"]

# Crear carpeta si no existe
def crear_dir(ruta):
    if not os.path.exists(ruta): os.makedirs(ruta)

# Detectar encoding
def get_encoding(archivo):
    try:
        with open(archivo, 'rb') as f:
            return chardet.detect(f.read(5000))['encoding'] or 'utf-8'
    except:
        return 'utf-8'

# Procesar Aclarabot
print("üöÄ Procesando Aclarabot...")
crear_dir(DESTINO)
ahora = datetime.now()
archivo_final = f"{DESTINO}/{ahora.strftime('%d')}-{ahora.strftime('%b')}.csv"

datos = []
for env in ENTORNOS:
    ruta = f"{RUTA_BASE}/{env}/Log/{ahora.year}/{ahora.strftime('%m')}/Log.csv"
    if os.path.exists(ruta):
        try:
            df = pd.read_csv(ruta, encoding=get_encoding(ruta), 
                           usecols=range(12), on_bad_lines='skip', engine='python')
            df.insert(0, 'ENTORNO', env)
            datos.append(df)
            print(f"  ‚úÖ {env}: {len(df)} filas")
        except:
            print(f"  ‚ùå {env}: Error")
    else:
        print(f"  ‚ö†Ô∏è  {env}: No encontrado")

if datos:
    pd.concat(datos).to_csv(archivo_final, index=False, encoding='utf-8-sig')
    print(f"üìä Guardado: {archivo_final}")

# Procesar Aclarapp
print("\nüì± Procesando Aclarapp...")
crear_dir(os.path.dirname(ACLARAPP))
if os.path.exists(ACLARAPP):
    try:
        df = pd.read_csv(ACLARAPP, encoding=get_encoding(ACLARAPP),
                       usecols=range(13), on_bad_lines='skip', engine='python')
        print(f"  ‚úÖ {len(df)} filas")
    except:
        print("  ‚ùå Error leyendo archivo")
else:
    pd.DataFrame(columns=[f"Col_{i}" for i in range(13)]).to_csv(ACLARAPP, index=False)
    print("  üìÑ Archivo vac√≠o creado")

print("\n‚úÖ Proceso terminado")
