import os
import glob
import pandas as pd

# ==============================
# CONFIGURACIÓN GENERAL
# ==============================
RUTA_BASE = r"\\hlah.adroot.hsbc\MX\RBWM\9870\CMU_preview\Proceso CMU\RPA Reporte y Cambio\Aclarabot"
RUTA_CSVS = os.path.join(RUTA_BASE, "Copia-reporte-Aclarabot")
RUTA_ACLARAPP = os.path.join(RUTA_BASE, "aclarapp.xlsx")


# ==============================
# FUNCIONES
# ==============================

def limpiar_archivos_csv(ruta):
    """Elimina todos los archivos .csv dentro de la carpeta indicada."""
    archivos = glob.glob(os.path.join(ruta, "*.csv"))
    for archivo in archivos:
        try:
            os.remove(archivo)
        except Exception as e:
            print(f"No se pudo eliminar {archivo}: {e}")


def buscar_log_csv(ruta):
    """Busca log.csv sin importar mayúsculas/minúsculas."""
    patrones = ["log.csv", "Log.csv", "LOG.csv"]
    for p in patrones:
        archivo = os.path.join(ruta, p)
        if os.path.exists(archivo):
            return archivo
    return None


def leer_csv_con_codificacion(archivo):
    """Lee un CSV probando codificaciones comunes para evitar errores de acentos."""
    encodings = ["utf-8", "latin-1", "cp1252"]
    for enc in encodings:
        try:
            return pd.read_csv(archivo, encoding=enc)
        except UnicodeDecodeError:
            continue
    raise Exception("No se pudo leer el archivo CSV con ninguna codificación conocida.")


def leer_excel_con_codificacion(ruta_excel):
    """
    Intenta leer un Excel y corrige nombres de columnas defectuosos,
    especialmente los casos donde 'É' aparece como 'Ã©'.
    """
    try:
        df = pd.read_excel(ruta_excel)
    except Exception as e:
        raise Exception(f"No se pudo leer el archivo aclarapp.xlsx: {e}")

    # Corrige acentos rotos
    nuevas_columnas = []
    for col in df.columns:
        nuevas_columnas.append(
            col.encode("latin1", errors="ignore").decode("utf-8", errors="ignore")
        )

    df.columns = nuevas_columnas
    return df


# ==============================
# PROCESO PRINCIPAL
# ==============================

def main():
    print("=== INICIANDO PROCESO DE ACLARABOT ===")

    # 1. Limpiar CSV previos
    print("Eliminando CSV previos...")
    limpiar_archivos_csv(RUTA_CSVS)

    # 2. Buscar log.csv independientemente de mayúsculas
    print("Buscando archivo log.csv...")
    archivo_log = buscar_log_csv(RUTA_CSVS)
    if not archivo_log:
        print("ERROR: No se encontró log.csv (en ninguna variante de mayúsculas).")
        return

    print(f"Archivo encontrado: {archivo_log}")

    # 3. Leer log.csv con codificación flexible
    try:
        df_log = leer_csv_con_codificacion(archivo_log)
    except Exception as e:
        print(f"ERROR al leer log.csv: {e}")
        return

    # 4. Leer aclarapp.xlsx con corrección de acentos
    print("Leyendo aclarapp.xlsx...")
    try:
        df_aclarapp = leer_excel_con_codificacion(RUTA_ACLARAPP)
    except Exception as e:
        print(f"ERROR al leer aclarapp.xlsx: {e}")
        return

    # Validar que haya filas válidas
    if df_aclarapp.empty:
        print("ERROR: No se encontraron filas válidas para la tabla aclarapp.")
        return

    print("Lectura de archivos completada correctamente.")
    print("Columnas detectadas en aclarapp:", list(df_aclarapp.columns))

    # Aquí continúa tu proceso normal...
    print("Proceso terminado con éxito.")


# ==============================
# EJECUCIÓN
# ==============================
if __name__ == "__main__":
    main()
