import os
import pandas as pd
from datetime import datetime
import chardet

# ============================================================
# CONFIGURACI√ìN
# ============================================================
RUTA_BASE = "../Carpeta/Aclarabot"
DESTINO = "c:/Copia-reporte-Aclarabot"
ACLARAPP = "c:/Copia-reporte-Aclarabot/Copy-Aclarapp/TablaCopiadaDeAclarapp.csv"
ENTORNOS = ["DEV", "UAT", "PROD"]


# ============================================================
# UTILIDADES
# ============================================================
def crear_dir(ruta):
    """Crear carpeta si no existe."""
    if not os.path.exists(ruta):
        os.makedirs(ruta)


def get_encoding(archivo):
    """Detectar encoding real del archivo."""
    try:
        with open(archivo, "rb") as f:
            enc = chardet.detect(f.read(5000))["encoding"]
            return enc or "utf-8"
    except:
        return "utf-8"


def buscar_log(ruta_folder):
    """Detectar Log.csv sin importar may√∫sculas."""
    nombres = ["Log.csv", "log.csv", "LOG.csv"]
    for nombre in nombres:
        ruta = os.path.join(ruta_folder, nombre)
        if os.path.exists(ruta):
            return ruta
    return None


# ============================================================
# LIMPIEZA DEL ARCHIVO PEGADO DE ACLARAPP
# ============================================================
def limpiar_aclarapp_csv(ruta):
    """Procesar el CSV pegado manualmente desde la p√°gina web."""

    with open(ruta, "r", encoding=get_encoding(ruta)) as f:
        lineas = [l.strip() for l in f.readlines()]

    # -------------------------
    # 1. Detectar encabezados en varias l√≠neas
    # -------------------------
    encabezados = []
    idx = 0

    while idx < len(lineas):
        linea = lineas[idx]

        # Fin de encabezados cuando encontremos la l√≠nea de tipos
        if linea.startswith("Varchar") or linea.startswith("Numero"):
            break

        # S√≥lo agregamos l√≠neas no vac√≠as
        if linea:
            encabezados.append(linea)

        idx += 1

    if len(encabezados) < 2:
        print("‚ö†Ô∏è No se encontraron encabezados v√°lidos.")
        return None

    # Unir encabezados en una sola l√≠nea CSV
    header = ",".join(encabezados)

    # -------------------------
    # 2. Saltar la fila de tipos (Varchar, Numero‚Ä¶)
    # -------------------------
    while idx < len(lineas) and not lineas[idx].startswith("Varchar"):
        idx += 1
    idx += 1  # saltar la fila de tipos

    # -------------------------
    # 3. Leer filas reales de la tabla
    # -------------------------
    filas = []
    for linea in lineas[idx:]:

        # Fin cuando empieza "Mostrando 1 a N‚Ä¶"
        if linea.startswith("Mostrando"):
            break

        # Quitar filas completamente vac√≠as (,,,)
        if linea.replace(",", "").strip() == "":
            continue

        filas.append(linea)

    if not filas:
        print("‚ö†Ô∏è No se encontraron filas v√°lidas en la tabla Aclarapp.")
        return None

    # -------------------------
    # 4. Crear DataFrame final
    # -------------------------
    columnas = header.split(",")
    datos = [f.split(",") for f in filas]

    df = pd.DataFrame(datos, columns=columnas)
    return df


# ============================================================
# PROCESO ACLARABOT
# ============================================================
print("üöÄ Procesando Aclarabot...")

crear_dir(DESTINO)

# Borrar todos los CSV previos
for file in os.listdir(DESTINO):
    if file.lower().endswith(".csv"):
        os.remove(os.path.join(DESTINO, file))

ahora = datetime.now()
archivo_final = f"{DESTINO}/{ahora.strftime('%d')}-{ahora.strftime('%b')}.csv"

year = ahora.year
mes = ahora.strftime("%m")

datos = []

for env in ENTORNOS:
    ruta_folder = f"{RUTA_BASE}/{env}/Log/{year}/{mes}"
    ruta = buscar_log(ruta_folder)

    if ruta:
        try:
            df = pd.read_csv(
                ruta,
                encoding=get_encoding(ruta),
                usecols=range(12),
                on_bad_lines="skip",
                engine="python"
            )
            df.insert(0, "ENTORNO", env)
            datos.append(df)
            print(f"  ‚úÖ {env}: {len(df)} filas")

        except Exception as e:
            print(f"  ‚ùå {env}: Error -> {e}")

    else:
        print(f"  ‚ö†Ô∏è {env}: No encontrado")

# Guardar archivo final de Aclarabot
if datos:
    final = pd.concat(datos, ignore_index=True)
    final.to_csv(archivo_final, index=False, encoding="utf-8-sig")
    print(f"üìä Guardado: {archivo_final}")


# ============================================================
# PROCESO ACLARAPP
# ============================================================
print("\nüì± Procesando Aclarapp...")

crear_dir(os.path.dirname(ACLARAPP))

if os.path.exists(ACLARAPP):
    df = limpiar_aclarapp_csv(ACLARAPP)

    if df is not None:
        df.to_csv(ACLARAPP, index=False, encoding="utf-8-sig")
        print(f"  ‚úÖ Archivo Aclarapp limpio ({len(df)} filas)")
    else:
        print("  ‚ùå No se pudo limpiar el archivo")
else:
    # Crear CSV vac√≠o si no existe
    columnas = [f"Col_{i}" for i in range(13)]
    pd.DataFrame(columns=columnas).to_csv(ACLARAPP, index=False, encoding="utf-8-sig")
    print("  üìÑ Archivo vac√≠o creado (Aclarapp)")


print("\n‚úÖ Proceso terminado")
