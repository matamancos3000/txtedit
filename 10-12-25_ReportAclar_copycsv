import os
import pandas as pd
from datetime import datetime
import re

# ==================== CONFIGURACIÃ“N ====================
RUTA_BASE_ACLARABOT = "../Carpeta/Aclarabot"
RUTA_DESTINO = "c:/Copia-reporte-Aclarabot"
RUTA_ACLARAPP = "c:/Copia-reporte-Aclarabot/Copy-Aclarapp/TablaCopiadaDeAclarapp.csv"
ENTORNOS = ["DEV", "UAT", "PROD"]

# ==================== FUNCIONES PARA ACLARABOT ====================
def procesar_aclarabot():
    """Procesa los archivos Log.csv de Aclarabot"""
    print("Procesando archivos Aclarabot...")
    
    # Preparar fecha
    ahora = datetime.now()
    fecha_archivo = f"{ahora.strftime('%d-%b')}.csv"
    ruta_final = os.path.join(RUTA_DESTINO, fecha_archivo)
    
    # Crear carpeta si no existe
    if not os.path.exists(RUTA_DESTINO):
        os.makedirs(RUTA_DESTINO)
    
    # Lista para guardar datos
    todos_datos = []
    
    for entorno in ENTORNOS:
        # Construir ruta del archivo
        ruta_archivo = os.path.join(
            RUTA_BASE_ACLARABOT, 
            entorno, 
            "Log", 
            str(ahora.year), 
            ahora.strftime("%m"), 
            "Log.csv"
        )
        
        if os.path.exists(ruta_archivo):
            print(f"  Leyendo {entorno}...")
            try:
                # Leer solo primeras 12 columnas
                df = pd.read_csv(ruta_archivo, usecols=range(12), 
                               encoding='utf-8', on_bad_lines='skip')
                
                # Agregar columna de entorno
                df.insert(0, 'ENTORNO', entorno)
                
                todos_datos.append(df)
                print(f"    âœ“ {len(df)} filas")
                
            except Exception as e:
                print(f"    âœ— Error en {entorno}: {e}")
        else:
            print(f"  âœ— Archivo no encontrado: {ruta_archivo}")
    
    # Combinar y guardar si hay datos
    if todos_datos:
        df_final = pd.concat(todos_datos, ignore_index=True)
        df_final.to_csv(ruta_final, index=False, encoding='utf-8-sig')
        print(f"\nâœ“ Aclarabot guardado: {ruta_final}")
        print(f"  Total: {len(df_final)} filas")
        return ruta_final
    else:
        print("\nâœ— No se procesaron archivos de Aclarabot")
        return None

# ==================== FUNCIONES PARA ACLARAPP ====================
def extraer_tabla_aclarapp(texto):
    """Extrae la tabla del texto copiado de la web"""
    
    # Buscar donde empieza la tabla
    lineas = texto.split('\n')
    
    # Patrones para buscar el inicio de la tabla
    patrones_inicio = [
        r'ID AclaraciÃ³n\s+Registro\s+Folio\s+CIS',
        r'ID AclaraciÃ³n.*Registro.*Folio.*CIS',
        'ID AclaraciÃ³n\tRegistro\tFolio\tCIS',
        'ID AclaraciÃ³n'
    ]
    
    inicio_idx = -1
    
    # Buscar inicio de tabla
    for i, linea in enumerate(lineas):
        linea_limpia = linea.strip()
        
        # Verificar si esta lÃ­nea contiene los encabezados
        if any(patron in linea_limpia for patron in patrones_inicio):
            inicio_idx = i
            print(f"  Tabla encontrada en lÃ­nea {i+1}")
            break
    
    if inicio_idx == -1:
        print("  No se encontrÃ³ el inicio de la tabla")
        return None
    
    # Obtener encabezados
    if '\t' in lineas[inicio_idx]:
        encabezados = lineas[inicio_idx].split('\t')
    else:
        # Intentar separar por espacios mÃºltiples
        encabezados = re.split(r'\s{2,}', lineas[inicio_idx])
    
    # Si no tenemos suficientes encabezados, usar los predeterminados
    if len(encabezados) < 11:
        encabezados = [
            'ID AclaraciÃ³n', 'Registro', 'Folio', 'CIS', 'Fecha CreaciÃ³n',
            'Fecha Enviado', 'Fecha Asignacion', 'Fecha Atendido', 
            'Estado Actual', 'Intentos', 'Acciones'
        ]
    
    # Recopilar filas de datos
    datos = []
    
    for i in range(inicio_idx + 1, len(lineas)):
        linea = lineas[i].strip()
        
        # Detener si encontramos el final
        if 'Mostrando' in linea or 'Mostrar' in linea or not linea:
            break
        
        # Separar la fila
        if '\t' in linea:
            fila = linea.split('\t')
        else:
            # Usar regex para separar por 2 o mÃ¡s espacios
            fila = re.split(r'\s{2,}', linea)
        
        # Asegurar que tenga 11 columnas
        if len(fila) >= 11:
            datos.append(fila[:11])
    
    if datos:
        print(f"  {len(datos)} filas extraÃ­das")
        return pd.DataFrame(datos, columns=encabezados[:11])
    else:
        print("  No se extrajeron datos")
        return None

def procesar_aclarapp():
    """Procesa el archivo de Aclarapp copiado de la web"""
    print("\nProcesando archivo Aclarapp...")
    
    # Crear carpeta si no existe
    carpeta_aclarapp = os.path.dirname(RUTA_ACLARAPP)
    if not os.path.exists(carpeta_aclarapp):
        os.makedirs(carpeta_aclarapp)
    
    if os.path.exists(RUTA_ACLARAPP):
        print(f"  Archivo encontrado: {RUTA_ACLARAPP}")
        
        try:
            # Leer archivo como texto
            with open(RUTA_ACLARAPP, 'r', encoding='utf-8') as f:
                contenido = f.read()
            
            # Extraer tabla
            df = extraer_tabla_aclarapp(contenido)
            
            if df is not None and not df.empty:
                # Guardar tabla limpia
                ruta_limpia = RUTA_ACLARAPP.replace('.csv', '_LIMPIADO.csv')
                df.to_csv(ruta_limpia, index=False, encoding='utf-8-sig')
                
                print(f"  âœ“ Tabla guardada: {ruta_limpia}")
                print(f"    {len(df)} filas, {len(df.columns)} columnas")
                
                # Mostrar vista previa
                print("\n  Vista previa:")
                print(df.head(3).to_string())
                
                return df
            else:
                print("  âœ— No se pudo extraer la tabla")
                return None
                
        except Exception as e:
            print(f"  âœ— Error procesando Aclarapp: {e}")
            return None
    else:
        print(f"  âœ— Archivo no encontrado: {RUTA_ACLARAPP}")
        print("  ðŸ’¡ Copia el texto de la web en este archivo")
        return None

# ==================== FUNCIÃ“N PRINCIPAL ====================
def main():
    """Ejecuta todo el proceso"""
    print("=" * 50)
    print("SISTEMA DE REPORTES - ACLARABOT Y ACLARAPP")
    print("=" * 50)
    
    # Procesar Aclarabot
    archivo_aclarabot = procesar_aclarabot()
    
    # Procesar Aclarapp
    df_aclarapp = procesar_aclarapp()
    
    print("\n" + "=" * 50)
    print("RESUMEN DEL PROCESO")
    print("=" * 50)
    
    if archivo_aclarabot:
        print(f"âœ“ Aclarabot: {archivo_aclarabot}")
    
    if df_aclarapp is not None:
        print(f"âœ“ Aclarapp: {len(df_aclarapp)} filas procesadas")
    
    print("\nâœ… Proceso completado")

# ==================== EJECUCIÃ“N ====================
if __name__ == "__main__":
    main()
