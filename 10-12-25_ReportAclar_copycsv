import os
import pandas as pd
from datetime import datetime
import chardet

# ConfiguraciÃ³n
RUTA_BASE = "../Carpeta/Aclarabot"
DESTINO = "c:/Copia-reporte-Aclarabot"
ACLARAPP = "c:/Copia-reporte-Aclarabot/Copy-Aclarapp/TablaCopiadaDeAclarapp.csv"
ENTORNOS = ["DEV", "UAT", "PROD"]

# Crear carpeta
def crear_dir(ruta):
    if not os.path.exists(ruta):
        os.makedirs(ruta)

# Detectar encoding
def get_encoding(archivo):
    try:
        with open(archivo, "rb") as f:
            enc = chardet.detect(f.read(5000))["encoding"]
            return enc or "utf-8"
    except:
        return "utf-8"

# Buscar Log.csv con may/min
def buscar_log(ruta_folder):
    nombres = ["Log.csv", "log.csv", "LOG.csv"]
    for nombre in nombres:
        ruta = os.path.join(ruta_folder, nombre)
        if os.path.exists(ruta):
            return ruta
    return None

# Proceso Aclarabot
print("ðŸš€ Procesando Aclarabot...")

crear_dir(DESTINO)

# Eliminar todos los CSV antes de crear uno nuevo
for file in os.listdir(DESTINO):
    if file.lower().endswith(".csv"):
        os.remove(os.path.join(DESTINO, file))

ahora = datetime.now()
archivo_final = f"{DESTINO}/{ahora.strftime('%d')}-{ahora.strftime('%b')}.csv"

year = ahora.year
mes = ahora.strftime("%m")

datos = []

for env in ENTORNOS:
    ruta_folder = f"{RUTA_BASE}/{env}/Log/{year}/{mes}"
    ruta = buscar_log(ruta_folder)

    if ruta:
        try:
            df = pd.read_csv(
                ruta,
                encoding=get_encoding(ruta),
                usecols=range(12),
                on_bad_lines="skip",
                engine="python"
            )
            df.insert(0, "ENTORNO", env)
            datos.append(df)
            print(f"  âœ… {env}: {len(df)} filas")
        except Exception as e:
            print(f"  âŒ {env}: Error -> {e}")
    else:
        print(f"  âš ï¸ {env}: No encontrado")

# Guardar final
if datos:
    final = pd.concat(datos, ignore_index=True)
    final.to_csv(archivo_final, index=False, encoding="utf-8-sig")
    print(f"ðŸ“Š Guardado: {archivo_final}")

# Procesar Aclarapp
print("\nðŸ“± Procesando Aclarapp...")
crear_dir(os.path.dirname(ACLARAPP))

if os.path.exists(ACLARAPP):
    try:
        df = pd.read_csv(
            ACLARAPP,
            encoding=get_encoding(ACLARAPP),
            usecols=range(13),
            on_bad_lines="skip",
            engine="python"
        )
        print(f"  âœ… {len(df)} filas")
    except Exception as e:
        print(f"  âŒ Error leyendo archivo -> {e}")
else:
    pd.DataFrame(columns=[f"Col_{i}" for i in range(13)]).to_csv(
        ACLARAPP, index=False, encoding="utf-8-sig"
    )
    print("  ðŸ“„ Archivo vacÃ­o creado")

print("\nâœ… Proceso terminado")
