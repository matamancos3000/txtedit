import os
import pandas as pd
from datetime import datetime
import re

# ==================== CONFIGURACI√ìN ====================
RUTA_BASE_ACLARABOT = "../Carpeta/Aclarabot"
RUTA_DESTINO = "c:/Copia-reporte-Aclarabot"
RUTA_ACLARAPP = "c:/Copia-reporte-Aclarabot/Copy-Aclarapp/TablaCopiadaDeAclarapp.csv"
ENTORNOS = ["DEV", "UAT", "PROD"]

# ==================== FUNCIONES PARA ACLARABOT ====================
def procesar_aclarabot():
    """Procesa los archivos Log.csv de Aclarabot"""
    print("Procesando archivos Aclarabot...")
    
    # Preparar fecha
    ahora = datetime.now()
    fecha_archivo = f"{ahora.strftime('%d-%b')}.csv"
    ruta_final = os.path.join(RUTA_DESTINO, fecha_archivo)
    
    # Crear carpeta si no existe
    if not os.path.exists(RUTA_DESTINO):
        os.makedirs(RUTA_DESTINO)
    
    # Lista para guardar datos
    todos_datos = []
    
    for entorno in ENTORNOS:
        # Construir ruta del archivo
        ruta_archivo = os.path.join(
            RUTA_BASE_ACLARABOT, 
            entorno, 
            "Log", 
            str(ahora.year), 
            ahora.strftime("%m"), 
            "Log.csv"
        )
        
        if os.path.exists(ruta_archivo):
            print(f"  Leyendo {entorno}...")
            try:
                # Leer solo primeras 12 columnas
                df = pd.read_csv(ruta_archivo, usecols=range(12), 
                               encoding='utf-8', on_bad_lines='skip')
                
                # Agregar columna de entorno
                df.insert(0, 'ENTORNO', entorno)
                
                todos_datos.append(df)
                print(f"    ‚úì {len(df)} filas")
                
            except Exception as e:
                print(f"    ‚úó Error en {entorno}: {e}")
        else:
            print(f"  ‚úó Archivo no encontrado: {ruta_archivo}")
    
    # Combinar y guardar si hay datos
    if todos_datos:
        df_final = pd.concat(todos_datos, ignore_index=True)
        df_final.to_csv(ruta_final, index=False, encoding='utf-8-sig')
        print(f"\n‚úì Aclarabot guardado: {ruta_final}")
        print(f"  Total: {len(df_final)} filas")
        return ruta_final
    else:
        print("\n‚úó No se procesaron archivos de Aclarabot")
        return None

# ==================== FUNCIONES PARA ACLARAPP ====================
def detectar_separador(linea):
    """Detecta el tipo de separador en una l√≠nea"""
    # Prioridad de separadores
    if '|' in linea:
        # Contar cu√°ntos pipes hay - si hay varios, es el separador
        if linea.count('|') >= 5:  # Al menos 5 pipes para ser considerado separador
            return '|'
    
    if '\t' in linea:
        # Si hay tab, usarlo
        return '\t'
    
    # Buscar m√∫ltiples espacios (3 o m√°s)
    if re.search(r'\s{3,}', linea):
        return 'multiples_espacios'
    
    # Si no se detecta ning√∫n separador claro, devolver None
    return None

def procesar_linea_con_separador(linea, separador):
    """Procesa una l√≠nea seg√∫n el separador detectado"""
    if separador == '|':
        # Separar por pipe, mantener valores vac√≠os
        partes = linea.split('|')
        # Limpiar espacios y mantener todos los campos
        return [part.strip() for part in partes]
    
    elif separador == '\t':
        # Separar por tab
        return linea.split('\t')
    
    elif separador == 'multiples_espacios':
        # Separar por 3 o m√°s espacios
        return re.split(r'\s{3,}', linea.strip())
    
    else:
        # Si no se detect√≥ separador, devolver la l√≠nea completa
        return [linea]

def extraer_tabla_aclarapp(texto):
    """Extrae la tabla del texto copiado de la web"""
    
    # Buscar donde empieza la tabla
    lineas = [linea.rstrip('\r') for linea in texto.split('\n')]
    
    # Patrones para buscar el inicio de la tabla
    patrones_inicio = [
        r'ID Aclaraci√≥n[\s\|]+Registro[\s\|]+Folio[\s\|]+CIS',
        r'ID Aclaraci√≥n.*Registro.*Folio.*CIS',
        'ID Aclaraci√≥n|Registro|Folio|CIS',
        'ID Aclaraci√≥n\tRegistro\tFolio\tCIS',
        'ID Aclaraci√≥n   Registro   Folio   CIS'
    ]
    
    inicio_idx = -1
    separador_detectado = None
    
    # Buscar inicio de tabla
    for i, linea in enumerate(lineas):
        linea_limpia = linea.strip()
        
        if not linea_limpia:
            continue
            
        # Verificar si esta l√≠nea contiene los encabezados
        for patron in patrones_inicio:
            # Para patrones con pipe literal
            if '|' in patron and '|' in linea_limpia:
                # Verificar que tenga varios campos separados por pipe
                if linea_limpia.count('|') >= 3:
                    inicio_idx = i
                    separador_detectado = detectar_separador(linea)
                    break
            # Para otros patrones
            elif patron in linea_limpia:
                inicio_idx = i
                separador_detectado = detectar_separador(linea)
                break
        
        if inicio_idx != -1:
            break
    
    if inicio_idx == -1:
        print("  No se encontr√≥ el inicio de la tabla")
        print("  Buscando 'ID Aclaraci√≥n' en primeras 30 l√≠neas...")
        for i, linea in enumerate(lineas[:30]):
            if 'ID Aclaraci√≥n' in linea:
                print(f"  L√≠nea {i+1}: {linea[:80]}")
                # Intentar detectar separador de esta l√≠nea
                sep = detectar_separador(linea)
                print(f"  Separador potencial: {repr(sep)}")
        return None
    
    print(f"  Tabla encontrada en l√≠nea {inicio_idx+1}")
    print(f"  Separador detectado: {repr(separador_detectado)}")
    
    # Mostrar la l√≠nea de encabezados para depuraci√≥n
    print(f"  L√≠nea encabezados: {lineas[inicio_idx][:100]}...")
    
    # Obtener encabezados usando el separador detectado
    if separador_detectado:
        encabezados = procesar_linea_con_separador(lineas[inicio_idx], separador_detectado)
    else:
        # Si no se detect√≥ separador, intentar adivinarlo
        print("  No se detect√≥ separador claro, intentando inferir...")
        
        # Verificar si tiene pipes
        if '|' in lineas[inicio_idx] and lineas[inicio_idx].count('|') >= 3:
            separador_detectado = '|'
        # Verificar si tiene tabs
        elif '\t' in lineas[inicio_idx]:
            separador_detectado = '\t'
        # Verificar si tiene m√∫ltiples espacios
        elif re.search(r'\s{3,}', lineas[inicio_idx]):
            separador_detectado = 'multiples_espacios'
        else:
            print("  No se pudo determinar el separador")
            return None
            
        encabezados = procesar_linea_con_separador(lineas[inicio_idx], separador_detectado)
    
    print(f"  Encabezados extra√≠dos ({len(encabezados)}): {encabezados}")
    
    # Si no tenemos suficientes encabezados, usar los predeterminados
    if len(encabezados) < 10:
        print(f"  S√≥lo se encontraron {len(encabezados)} encabezados, usando predeterminados")
        encabezados = [
            'ID Aclaraci√≥n', 'Registro', 'Folio', 'CIS', 'Fecha Creaci√≥n',
            'Fecha Enviado', 'Fecha Asignacion', 'Fecha Atendido', 
            'Estado Actual', 'Intentos', 'Acciones'
        ]
    
    # Recopilar filas de datos
    datos = []
    lineas_procesadas = 0
    
    for i in range(inicio_idx + 1, len(lineas)):
        linea = lineas[i].strip()
        
        # Si la l√≠nea est√° vac√≠a, continuar
        if not linea:
            continue
            
        # Detener si encontramos el final
        if 'Mostrando' in linea or 'Mostrar' in linea or 'entradas' in linea.lower():
            print(f"  Fin de tabla detectado en l√≠nea {i+1}: '{linea[:50]}...'")
            break
        
        # Verificar si parece ser una l√≠nea de datos
        # Debe tener una longitud m√≠nima y no ser solo texto
        if len(linea) < 30:  # L√≠nea muy corta probablemente no sea datos
            continue
        
        lineas_procesadas += 1
        
        # Procesar la l√≠nea con el separador detectado
        fila = procesar_linea_con_separador(lineas[i], separador_detectado)
        
        # Filtrar elementos vac√≠os
        fila = [campo for campo in fila if campo != '']
        
        # Asegurar que tenga suficientes columnas
        if len(fila) >= 10:
            # Si tiene exactamente 10, agregar campo vac√≠o para Acciones
            if len(fila) == 10:
                fila.append('')
            datos.append(fila[:11])
        elif 7 <= len(fila) < 10:
            # Rellenar con valores vac√≠os hasta tener 11
            while len(fila) < 11:
                fila.append('')
            datos.append(fila[:11])
    
    print(f"  L√≠neas procesadas: {lineas_procesadas}")
    
    if datos:
        print(f"  {len(datos)} filas de datos extra√≠das")
        
        # Crear DataFrame
        try:
            # Asegurarnos de que tenemos suficientes columnas
            columnas_finales = encabezados[:11] if len(encabezados) >= 11 else encabezados
            
            # Si no tenemos 11 columnas, agregar nombres gen√©ricos para las que faltan
            while len(columnas_finales) < 11:
                columnas_finales.append(f'Columna_{len(columnas_finales)+1}')
            
            df = pd.DataFrame(datos, columns=columnas_finales)
            print(f"  DataFrame creado: {len(df)} filas x {len(df.columns)} columnas")
            return df
            
        except Exception as e:
            print(f"  Error creando DataFrame: {e}")
            print(f"  N√∫mero de columnas en datos: {len(datos[0]) if datos else 0}")
            
            # Intentar mostrar las primeras filas para depuraci√≥n
            if datos:
                print("  Primeras 2 filas de datos:")
                for j, fila in enumerate(datos[:2]):
                    print(f"  Fila {j+1}: {fila}")
            
            return None
    else:
        print("  No se extrajeron datos")
        return None

def procesar_aclarapp():
    """Procesa el archivo de Aclarapp copiado de la web"""
    print("\nProcesando archivo Aclarapp...")
    
    # Crear carpeta si no existe
    carpeta_aclarapp = os.path.dirname(RUTA_ACLARAPP)
    if not os.path.exists(carpeta_aclarapp):
        os.makedirs(carpeta_aclarapp)
    
    if os.path.exists(RUTA_ACLARAPP):
        print(f"  Archivo encontrado: {RUTA_ACLARAPP}")
        
        try:
            # Leer archivo como texto
            with open(RUTA_ACLARAPP, 'r', encoding='utf-8') as f:
                contenido = f.read()
            
            print(f"  Tama√±o del archivo: {len(contenido)} caracteres")
            print(f"  N√∫mero de l√≠neas: {contenido.count(chr(10)) + 1}")
            
            # Extraer tabla
            df = extraer_tabla_aclarapp(contenido)
            
            if df is not None and not df.empty:
                # Guardar tabla limpia
                ruta_limpia = RUTA_ACLARAPP.replace('.csv', '_LIMPIADO.csv')
                df.to_csv(ruta_limpia, index=False, encoding='utf-8-sig')
                
                print(f"  ‚úì Tabla guardada: {ruta_limpia}")
                print(f"    {len(df)} filas, {len(df.columns)} columnas")
                
                # Mostrar vista previa
                print("\n  Vista previa (primeras 3 filas):")
                print(df.head(3).to_string(index=False))
                
                return df
            else:
                print("  ‚úó No se pudo extraer la tabla")
                print("  Mostrando primeras 15 l√≠neas del archivo:")
                lineas = contenido.split('\n')
                for i, linea in enumerate(lineas[:15]):
                    print(f"  {i+1:3}: {repr(linea)[:80]}")
                return None
                
        except Exception as e:
            print(f"  ‚úó Error procesando Aclarapp: {e}")
            return None
    else:
        print(f"  ‚úó Archivo no encontrado: {RUTA_ACLARAPP}")
        print("  üí° Copia el texto de la web en este archivo")
        return None

# ==================== FUNCI√ìN PRINCIPAL ====================
def main():
    """Ejecuta todo el proceso"""
    print("=" * 60)
    print("SISTEMA DE REPORTES - ACLARABOT Y ACLARAPP")
    print("=" * 60)
    
    # Procesar Aclarabot
    archivo_aclarabot = procesar_aclarabot()
    
    # Procesar Aclarapp
    df_aclarapp = procesar_aclarapp()
    
    print("\n" + "=" * 60)
    print("RESUMEN DEL PROCESO")
    print("=" * 60)
    
    if archivo_aclarabot:
        print(f"‚úì Aclarabot: {archivo_aclarabot}")
    
    if df_aclarapp is not None:
        print(f"‚úì Aclarapp: {len(df_aclarapp)} filas procesadas")
        print(f"  Archivo limpio: TablaCopiadaDeAclarapp_LIMPIADO.csv")
    
    print("\n‚úÖ Proceso completado")

# ==================== EJECUCI√ìN ====================
if __name__ == "__main__":
    main()
