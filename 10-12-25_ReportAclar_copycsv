import os
import pandas as pd
from datetime import datetime
import glob
import shutil

def crear_carpeta_si_no_existe(ruta):
    """Crea una carpeta si no existe"""
    if not os.path.exists(ruta):
        os.makedirs(ruta)
        print("ğŸ“ Carpeta creada:", ruta)
    return ruta

def detectar_codificacion(ruta_archivo):
    """Intenta detectar la codificaciÃ³n del archivo"""
    import chardet
    
    try:
        with open(ruta_archivo, 'rb') as f:
            raw_data = f.read(10000)  # Leer solo los primeros 10KB para detectar
            resultado = chardet.detect(raw_data)
            encoding = resultado['encoding']
            confianza = resultado['confidence']
            
            print(f"   ğŸ” CodificaciÃ³n detectada: {encoding} (confianza: {confianza:.2%})")
            
            # Si la confianza es baja o es None, usar UTF-8
            if encoding is None or confianza < 0.7:
                return 'utf-8'
            
            # Asegurar que usamos una codificaciÃ³n vÃ¡lida
            if encoding.lower() == 'iso-8859-1':
                return 'latin-1'
            elif encoding.lower() == 'windows-1252':
                return 'cp1252'
            else:
                return encoding
    except Exception as e:
        print(f"   âš ï¸  Error detectando codificaciÃ³n: {e}")
        return 'utf-8'

def leer_csv_con_codificacion(ruta_archivo, n_columnas=None, sep=','):
    """Lee un CSV intentando diferentes codificaciones"""
    codificaciones_a_probar = [
        'utf-8',
        'latin-1',
        'iso-8859-1',
        'cp1252',
        'windows-1252',
        'utf-8-sig'  # Para archivos con BOM
    ]
    
    for i, encoding in enumerate(codificaciones_a_probar, 1):
        try:
            if n_columnas:
                df = pd.read_csv(ruta_archivo, encoding=encoding, 
                                usecols=range(n_columnas), sep=sep,
                                on_bad_lines='skip', low_memory=False)
            else:
                df = pd.read_csv(ruta_archivo, encoding=encoding, 
                                sep=sep, on_bad_lines='skip', low_memory=False)
            
            print(f"   âœ… CodificaciÃ³n exitosa: {encoding}")
            return df
        except UnicodeDecodeError:
            if i == len(codificaciones_a_probar):
                print(f"   âŒ No se pudo leer con ninguna codificaciÃ³n")
                raise
            continue
        except Exception as e:
            print(f"   âš ï¸  Error con {encoding}: {e}")
            if i == len(codificaciones_a_probar):
                raise
    
    # Si llegamos aquÃ­, intentamos una Ãºltima opciÃ³n
    try:
        print("   ğŸ”„ Intentando leer con engine='python'...")
        if n_columnas:
            df = pd.read_csv(ruta_archivo, encoding='utf-8',
                           usecols=range(n_columnas), sep=sep,
                           engine='python', on_bad_lines='skip')
        else:
            df = pd.read_csv(ruta_archivo, encoding='utf-8',
                           sep=sep, engine='python', on_bad_lines='skip')
        print("   âœ… Lectura exitosa con engine='python'")
        return df
    except Exception as e:
        print(f"   âŒ Error final: {e}")
        raise

def procesar_archivos_aclarabot():
    """Procesa los archivos de Aclarabot de los 3 entornos"""
    print("\n" + "="*60)
    print("ğŸš€ PROCESANDO ARCHIVOS ACLARABOT")
    print("="*60)
    
    # Obtener fecha actual
    ahora = datetime.now()
    aÃ±o_actual = ahora.year
    mes_actual = ahora.strftime("%m")
    dia_actual = ahora.strftime("%d")
    
    # Definir rutas base
    ruta_base = "../Carpeta/Aclarabot"
    entornos = ["DEV", "UAT", "PROD"]
    
    # Crear carpeta de destino
    carpeta_destino_base = "c:/Copia-reporte-Aclarabot"
    crear_carpeta_si_no_existe(carpeta_destino_base)
    
    # Nombre del archivo final (ej: 10-Nov-Dec.csv)
    nombre_archivo_final = f"{dia_actual}-{ahora.strftime('%b')}.csv"
    ruta_final = os.path.join(carpeta_destino_base, nombre_archivo_final)
    
    # Lista para almacenar todos los DataFrames
    datos_combinados = []
    
    for entorno in entornos:
        print(f"\nğŸ” Buscando archivo para entorno: {entorno}")
        
        # Construir la ruta del archivo
        ruta_archivo = os.path.join(ruta_base, entorno, "Log", str(aÃ±o_actual), mes_actual, "Log.csv")
        
        if os.path.exists(ruta_archivo):
            print(f"   âœ… Archivo encontrado: {ruta_archivo}")
            print(f"   ğŸ“ TamaÃ±o: {os.path.getsize(ruta_archivo):,} bytes")
            
            try:
                # Detectar codificaciÃ³n primero
                print("   ğŸ” Detectando codificaciÃ³n...")
                encoding = detectar_codificacion(ruta_archivo)
                
                # Leer el archivo CSV con la codificaciÃ³n correcta
                df = pd.read_csv(ruta_archivo, encoding=encoding, 
                               usecols=range(12), sep=',',
                               on_bad_lines='skip', low_memory=False)
                
                # Mostrar informaciÃ³n sobre las columnas
                print(f"   ğŸ“Š Columnas originales: {len(df.columns)}")
                
                # Agregar columna de entorno al principio
                df.insert(0, 'ENTORNO', entorno)
                
                # Verificar caracteres especiales
                print("   ğŸ”¤ Verificando caracteres especiales...")
                muestra_texto = df.iloc[0].astype(str).str.cat(sep=' ')[:100]
                print(f"   ğŸ‘€ Muestra de texto: {muestra_texto}")
                
                datos_combinados.append(df)
                print(f"   âœ… Filas procesadas: {len(df):,}")
                
            except Exception as e:
                print(f"   âŒ Error al procesar {entorno}: {e}")
                print("   ğŸ”„ Intentando mÃ©todo alternativo...")
                try:
                    df = leer_csv_con_codificacion(ruta_archivo, n_columnas=12)
                    df.insert(0, 'ENTORNO', entorno)
                    datos_combinados.append(df)
                    print(f"   âœ… Filas procesadas (mÃ©todo alternativo): {len(df):,}")
                except Exception as e2:
                    print(f"   âŒ Error en mÃ©todo alternativo: {e2}")
        else:
            print(f"   âš ï¸  Archivo no encontrado: {ruta_archivo}")
    
    if datos_combinados:
        # Combinar todos los DataFrames
        df_final = pd.concat(datos_combinados, ignore_index=True)
        
        # Guardar el archivo combinado con UTF-8 para garantizar compatibilidad
        df_final.to_csv(ruta_final, index=False, encoding='utf-8-sig')
        
        print(f"\nâœ¨ ARCHIVO ACLARABOT GUARDADO EXITOSAMENTE")
        print(f"   ğŸ“ Ruta: {ruta_final}")
        print(f"   ğŸ“ˆ Total de filas: {len(df_final):,}")
        print(f"   ğŸ“Š Total de columnas: {len(df_final.columns)}")
        print(f"   ğŸ’¾ TamaÃ±o del archivo: {os.path.getsize(ruta_final):,} bytes")
        
        return ruta_final, df_final
    else:
        print("\nâŒ No se encontraron datos para procesar")
        return None, None

def procesar_archivo_aclarapp():
    """Procesa el archivo de Aclarapp"""
    print("\n" + "="*60)
    print("ğŸ“± PROCESANDO ARCHIVO ACLARAPP")
    print("="*60)
    
    # Ruta del archivo de Aclarapp
    ruta_aclarapp = "c:/Copia-reporte-Aclarabot/Copy-Aclarapp/TablaCopiadaDeAclarapp.csv"
    
    # Crear carpeta si no existe
    carpeta_aclarapp = os.path.dirname(ruta_aclarapp)
    crear_carpeta_si_no_existe(carpeta_aclarapp)
    
    if os.path.exists(ruta_aclarapp):
        print(f"âœ… Archivo encontrado: {ruta_aclarapp}")
        print(f"ğŸ“ TamaÃ±o: {os.path.getsize(ruta_aclarapp):,} bytes")
        
        try:
            # Detectar codificaciÃ³n primero
            print("ğŸ” Detectando codificaciÃ³n...")
            encoding = detectar_codificacion(ruta_aclarapp)
            
            # Leer el archivo con la codificaciÃ³n correcta
            df_aclarapp = pd.read_csv(ruta_aclarapp, encoding=encoding,
                                    usecols=range(13), sep=',',
                                    on_bad_lines='skip', low_memory=False)
            
            print(f"ğŸ“Š Filas procesadas: {len(df_aclarapp):,}")
            print(f"ğŸ“ˆ Columnas procesadas: {len(df_aclarapp.columns)}")
            
            # Verificar caracteres especiales
            print("ğŸ”¤ Verificando caracteres especiales...")
            if len(df_aclarapp) > 0:
                muestra_texto = df_aclarapp.iloc[0].astype(str).str.cat(sep=' ')[:100]
                print(f"ğŸ‘€ Muestra de texto: {muestra_texto}")
                
                # Verificar si hay caracteres mal codificados
                caracteres_problema = ['ÃƒÂ©', 'ÃƒÂ¡', 'ÃƒÂ­', 'ÃƒÂ³', 'ÃƒÂº', 'ÃƒÂ±']
                for char in caracteres_problema:
                    if df_aclarapp.astype(str).apply(lambda x: x.str.contains(char)).any().any():
                        print(f"   âš ï¸  Se detectÃ³ posible caracter mal codificado: {char}")
            
            # Mostrar primeras filas
            print("\nğŸ‘€ Vista previa de los datos:")
            print(df_aclarapp.head())
            
            return df_aclarapp
            
        except Exception as e:
            print(f"âŒ Error al procesar archivo Aclarapp: {e}")
            print("ğŸ”„ Intentando mÃ©todo alternativo...")
            try:
                df_aclarapp = leer_csv_con_codificacion(ruta_aclarapp, n_columnas=13)
                print(f"âœ… Archivo procesado con mÃ©todo alternativo")
                print(f"ğŸ“Š Filas: {len(df_aclarapp):,}")
                return df_aclarapp
            except Exception as e2:
                print(f"âŒ Error en mÃ©todo alternativo: {e2}")
                return None
    else:
        print(f"âš ï¸  Archivo no encontrado: {ruta_aclarapp}")
        print("ğŸ’¡ Por favor, coloca el archivo en la ubicaciÃ³n especificada")
        
        # Crear archivo de ejemplo vacÃ­o
        columnas = [f"Columna_{i+1}" for i in range(13)]
        df_vacio = pd.DataFrame(columns=columnas)
        df_vacio.to_csv(ruta_aclarapp, index=False, encoding='utf-8-sig')
        print(f"ğŸ“„ Se ha creado un archivo vacÃ­o en: {ruta_aclarapp}")
        
        return None

def corregir_caracteres_mal_codificados(df):
    """Corrige caracteres mal codificados comunes"""
    if df is None:
        return df
    
    # Diccionario de correcciones
    correcciones = {
        'ÃƒÂ¡': 'Ã¡', 'ÃƒÂ©': 'Ã©', 'ÃƒÂ­': 'Ã­', 'ÃƒÂ³': 'Ã³', 'ÃƒÂº': 'Ãº',
        'ÃƒÂ±': 'Ã±', 'ÃƒÂ': 'Ã', 'Ãƒâ€°': 'Ã‰', 'Ãƒ': 'Ã', 'Ãƒâ€œ': 'Ã“',
        'ÃƒÅ¡': 'Ãš', 'Ãƒâ€˜': 'Ã‘', 'ÃƒÂ¼': 'Ã¼', 'ÃƒÅ“': 'Ãœ',
        'Ãƒâ‚¬': 'Ã€', 'ÃƒË†': 'Ãˆ', 'ÃƒÅ’': 'ÃŒ', 'Ãƒâ€™': 'Ã’', 'Ãƒâ„¢': 'Ã™',
        'ÃƒÂ§': 'Ã§', 'Ãƒâ€¡': 'Ã‡', 'ÃƒÂ£': 'Ã£', 'ÃƒÂµ': 'Ãµ', 'ÃƒÂ£': 'Ã£',
        'ÃƒÂ¢': 'Ã¢', 'ÃƒÂª': 'Ãª', 'ÃƒÂ®': 'Ã®', 'ÃƒÂ´': 'Ã´', 'ÃƒÂ»': 'Ã»'
    }
    
    # Aplicar correcciones a todas las columnas de texto
    for col in df.columns:
        if df[col].dtype == 'object':
            for mal, bien in correcciones.items():
                df[col] = df[col].astype(str).str.replace(mal, bien, regex=False)
    
    return df

def generar_reporte_resumen(df_aclarabot, df_aclarapp):
    """Genera un reporte resumen de los datos procesados"""
    print("\n" + "="*60)
    print("ğŸ“Š REPORTE RESUMEN")
    print("="*60)
    
    if df_aclarabot is not None:
        print("\nğŸ“‹ ACLARABOT:")
        print(f"   Total de registros: {len(df_aclarabot):,}")
        print(f"   Total de columnas: {len(df_aclarabot.columns)}")
        
        # Conteo por entorno
        if 'ENTORNO' in df_aclarabot.columns:
            conteo_entornos = df_aclarabot['ENTORNO'].value_counts()
            print("\n   DistribuciÃ³n por entorno:")
            for entorno, cantidad in conteo_entornos.items():
                print(f"   - {entorno}: {cantidad:,} registros")
    
    if df_aclarapp is not None:
        print("\nğŸ“± ACLARAPP:")
        print(f"   Total de registros: {len(df_aclarapp):,}")
        print(f"   Total de columnas: {len(df_aclarapp.columns)}")
    
    print("\n" + "="*60)
    print("ğŸ‰ PROCESO COMPLETADO EXITOSAMENTE!")
    print("="*60)

def main():
    """FunciÃ³n principal"""
    print("\n" + "âœ¨" * 30)
    print("   REPORTE ACLARABOT Y ACLARAPP")
    print("âœ¨" * 30)
    print("ğŸ”¤ VersiÃ³n con correcciÃ³n de codificaciÃ³n de caracteres")
    print("="*60)
    
    # Procesar archivos de Aclarabot
    ruta_aclarabot, df_aclarabot = procesar_archivos_aclarabot()
    
    # Aplicar correcciÃ³n de caracteres si es necesario
    if df_aclarabot is not None:
        df_aclarabot = corregir_caracteres_mal_codificados(df_aclarabot)
    
    # Procesar archivo de Aclarapp
    df_aclarapp = procesar_archivo_aclarapp()
    
    # Aplicar correcciÃ³n de caracteres si es necesario
    if df_aclarapp is not None:
        df_aclarapp = corregir_caracteres_mal_codificados(df_aclarapp)
    
    # Generar reporte resumen
    generar_reporte_resumen(df_aclarabot, df_aclarapp)
    
    # Mostrar ubicaciÃ³n de archivos generados
    if ruta_aclarabot:
        print(f"\nğŸ“ Archivo Aclarabot generado en:\n   {ruta_aclarabot}")
        print(f"   CodificaciÃ³n: UTF-8 with BOM (para Excel)")
    
    print("\nğŸ¤– Â¡Listo! Todos los archivos han sido procesados.")
    print("ğŸ”¤ Los caracteres especiales han sido corregidos.")
    print("ğŸ’¾ Recuerda guardar tus archivos de entrada para futuros reportes.")

if __name__ == "__main__":
    # Instalar chardet si no estÃ¡ disponible
    try:
        import chardet
    except ImportError:
        print("ğŸ“¦ Instalando chardet para detecciÃ³n de codificaciÃ³n...")
        import subprocess
        import sys
        subprocess.check_call([sys.executable, "-m", "pip", "install", "chardet"])
        import chardet
    
    main()
