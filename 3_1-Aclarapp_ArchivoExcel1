import pandas as pd
import logging
from pathlib import Path
import re
from datetime import datetime, timedelta
import numpy as np
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Border, Side, Alignment, NamedStyle
from openpyxl.chart import BarChart, PieChart, Reference, Series
from openpyxl.utils import get_column_letter

# =========================
# LOGGING
# =========================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

# =========================
# CONFIGURACI√ìN
# =========================
BASE_PATH = Path("c:/Copia-reporte-Aclarabot")

# Buscar archivo CSV filtrado
CSV_PATTERN = "Acumulado_Filtrado_*.csv"
ARCHIVO_CSV = None
for archivo in BASE_PATH.glob(CSV_PATTERN):
    ARCHIVO_CSV = archivo
    break

if ARCHIVO_CSV is None:
    logger.error(f"No se encontr√≥ archivo {CSV_PATTERN} en {BASE_PATH}")
    exit(1)

# Crear carpeta para archivos Excel
EXCEL_FOLDER = BASE_PATH / "archivos_Excel"
EXCEL_FOLDER.mkdir(exist_ok=True)

# Nombre din√°mico del archivo Excel (en espa√±ol)
meses_es = {
    1: "Enero", 2: "Febrero", 3: "Marzo", 4: "Abril",
    5: "Mayo", 6: "Junio", 7: "Julio", 8: "Agosto",
    9: "Septiembre", 10: "Octubre", 11: "Noviembre", 12: "Diciembre"
}
fecha_hoy = datetime.now()
NOMBRE_EXCEL = f"Reporte_Aclarapp_{fecha_hoy.day}-{meses_es[fecha_hoy.month]}.xlsx"
RUTA_EXCEL = EXCEL_FOLDER / NOMBRE_EXCEL

# =========================
# FUNCIONES
# =========================
def limpiar_formato_fecha_especial(valor):
    """
    Limpia formato especial: dd/MM/yyyy hh:mm:ss p. m. (con espacio entre p. y m.)
    y a. m.
    """
    if pd.isna(valor):
        return valor
    
    valor_str = str(valor).strip()
    
    if not valor_str or valor_str.lower() in ['nan', 'nat', 'null', 'none', '']:
        return valor
    
    # Corregir el espacio entre p. y m. / a. y m.
    valor_str = re.sub(r'p\.\s*m\.', 'PM', valor_str, flags=re.IGNORECASE)
    valor_str = re.sub(r'a\.\s*m\.', 'AM', valor_str, flags=re.IGNORECASE)
    
    return valor_str.strip()

def parsear_fecha(fecha_str):
    """Convierte string de fecha a datetime"""
    if pd.isna(fecha_str):
        return pd.NaT
    
    # Limpiar formato especial
    fecha_limpia = limpiar_formato_fecha_especial(fecha_str)
    
    # Intentar parsear
    try:
        return pd.to_datetime(fecha_limpia, format="%d/%m/%Y %I:%M:%S %p", errors='coerce')
    except:
        return pd.to_datetime(fecha_limpia, dayfirst=True, errors='coerce')

def calcular_tiempo_minutos(fecha_inicio, fecha_fin):
    """Calcula diferencia en minutos entre dos fechas"""
    if pd.isna(fecha_inicio) or pd.isna(fecha_fin):
        return np.nan
    
    try:
        diferencia = fecha_fin - fecha_inicio
        return diferencia.total_seconds() / 60  # Convertir a minutos
    except:
        return np.nan

def aplicar_formato_excel(wb, ws, df):
    """Aplica formato a la hoja de Excel usando openpyxl"""
    
    # Definir estilos
    header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
    header_font = Font(bold=True, color="FFFFFF")
    border = Border(
        left=Side(style='thin'),
        right=Side(style='thin'),
        top=Side(style='thin'),
        bottom=Side(style='thin')
    )
    center_alignment = Alignment(horizontal="center", vertical="center")
    
    # Aplicar formato a encabezados
    for col_num, column_name in enumerate(df.columns, 1):
        cell = ws.cell(row=1, column=col_num, value=column_name)
        cell.fill = header_fill
        cell.font = header_font
        cell.border = border
        cell.alignment = center_alignment
        
        # Ajustar ancho de columna
        max_length = max(df[column_name].astype(str).apply(len).max(), len(column_name))
        ws.column_dimensions[get_column_letter(col_num)].width = min(max_length + 2, 30)
    
    # Aplicar formato a datos
    for row in range(2, len(df) + 2):
        for col_num, column_name in enumerate(df.columns, 1):
            cell = ws.cell(row=row, column=col_num)
            cell_value = df.iat[row-2, col_num-1]
            
            # Aplicar bordes y alineaci√≥n
            cell.border = border
            cell.alignment = center_alignment
            
            # Asignar valor
            if pd.isna(cell_value):
                cell.value = None
            elif 'Fecha' in column_name:
                if isinstance(cell_value, (pd.Timestamp, datetime)):
                    cell.value = cell_value
                    cell.number_format = 'DD/MM/YYYY HH:MM:SS'
                else:
                    cell.value = cell_value
            elif 'Tiempo' in column_name and 'segundos' not in column_name.lower():
                if pd.notna(cell_value):
                    cell.value = cell_value
                    # Formato de tiempo en minutos
                    cell.number_format = '0.00 "min"'
            elif 'segundos' in column_name.lower():
                if pd.notna(cell_value):
                    cell.value = cell_value
                    cell.number_format = '#,##0'
            else:
                cell.value = cell_value

def crear_graficas_openpyxl(wb, df):
    """Crea gr√°ficas usando openpyxl"""
    
    # =========================
    # HOJA: Resumen General
    # =========================
    ws_resumen = wb.create_sheet(title="Resumen General")
    
    # T√≠tulos
    ws_resumen['A1'] = "ESTAD√çSTICAS DEL REPORTE"
    ws_resumen['A1'].font = Font(bold=True, size=14)
    
    # Estad√≠sticas b√°sicas
    stats = [
        ['Total de registros', len(df)],
        ['Registros exitosos', df['Estatus'].eq('exitoso').sum()],
        ['Agentes involucrados', df['Nombre Agente'].nunique()],
        ['Tipos de aclaraci√≥n', df['Tipo de aclaracion'].nunique()],
        ['Tiempo promedio captura (min)', f"{df['Tiempo de captura agente'].mean():.2f}"],
        ['Tiempo promedio alta robot (min)', f"{df['Tiempo de alta robot'].mean():.2f}"]
    ]
    
    if 'Cargos' in df.columns and df['Cargos'].notna().any():
        try:
            cargos_totales = pd.to_numeric(df['Cargos'], errors='coerce').sum()
            stats.append(['Cargos totales', f"{cargos_totales:,.2f}"])
        except:
            pass
    
    # Escribir estad√≠sticas
    for i, (label, value) in enumerate(stats, start=3):
        ws_resumen[f'A{i}'] = label
        ws_resumen[f'B{i}'] = value
        ws_resumen[f'A{i}'].font = Font(bold=True)
    
    # =========================
    # HOJA: Gr√°ficas
    # =========================
    ws_graficas = wb.create_sheet(title="Gr√°ficas")
    
    # Gr√°fica 1 - Aclaraciones por Agente (Top 10)
    ws_graficas['A1'] = "TOP 10 AGENTES POR ACLARACIONES"
    ws_graficas['A1'].font = Font(bold=True, size=12)
    
    aclaraciones_por_agente = df['Nombre Agente'].value_counts().head(10)
    
    ws_graficas['A3'] = 'Agente'
    ws_graficas['B3'] = 'Cantidad de Aclaraciones'
    ws_graficas['A3'].font = Font(bold=True)
    ws_graficas['B3'].font = Font(bold=True)
    
    for i, (agente, cantidad) in enumerate(aclaraciones_por_agente.items(), start=4):
        ws_graficas[f'A{i}'] = agente
        ws_graficas[f'B{i}'] = cantidad
    
    # Crear gr√°fica de barras
    chart1 = BarChart()
    chart1.type = "col"
    chart1.style = 10
    chart1.title = "Top 10 Agentes por Aclaraciones"
    chart1.y_axis.title = "Cantidad de Aclaraciones"
    chart1.x_axis.title = "Agente"
    
    data = Reference(ws_graficas, min_col=2, min_row=3, max_row=3+len(aclaraciones_por_agente))
    cats = Reference(ws_graficas, min_col=1, min_row=4, max_row=3+len(aclaraciones_por_agente))
    
    chart1.add_data(data, titles_from_data=True)
    chart1.set_categories(cats)
    chart1.shape = 4
    
    ws_graficas.add_chart(chart1, "D3")
    
    # Gr√°fica 2 - Tipos de Aclaraci√≥n
    start_row = len(aclaraciones_por_agente) + 8
    ws_graficas[f'A{start_row}'] = "DISTRIBUCI√ìN POR TIPO DE ACLARACI√ìN"
    ws_graficas[f'A{start_row}'].font = Font(bold=True, size=12)
    
    tipos_aclaracion = df['Tipo de aclaracion'].value_counts()
    
    ws_graficas[f'A{start_row+2}'] = 'Tipo de Aclaraci√≥n'
    ws_graficas[f'B{start_row+2}'] = 'Cantidad'
    ws_graficas[f'A{start_row+2}'].font = Font(bold=True)
    ws_graficas[f'B{start_row+2}'].font = Font(bold=True)
    
    for i, (tipo, cantidad) in enumerate(tipos_aclaracion.items(), start=1):
        ws_graficas[f'A{start_row+2+i}'] = tipo
        ws_graficas[f'B{start_row+2+i}'] = cantidad
    
    # Crear gr√°fica de pastel
    chart2 = PieChart()
    chart2.title = "Distribuci√≥n por Tipo de Aclaraci√≥n"
    
    data2 = Reference(ws_graficas, min_col=2, min_row=start_row+2, 
                     max_row=start_row+2+len(tipos_aclaracion))
    labels = Reference(ws_graficas, min_col=1, min_row=start_row+3, 
                      max_row=start_row+2+len(tipos_aclaracion))
    
    chart2.add_data(data2, titles_from_data=True)
    chart2.set_categories(labels)
    
    ws_graficas.add_chart(chart2, f"D{start_row+2}")
    
    # Gr√°fica 3 - Tiempos Promedio por Agente
    start_row3 = start_row + len(tipos_aclaracion) + 8
    ws_graficas[f'A{start_row3}'] = "TIEMPOS PROMEDIO POR AGENTE (TOP 10)"
    ws_graficas[f'A{start_row3}'].font = Font(bold=True, size=12)
    
    tiempos_por_agente = df.groupby('Nombre Agente').agg({
        'Tiempo de captura agente': 'mean',
        'Tiempo de alta robot': 'mean'
    }).head(10)
    
    ws_graficas[f'A{start_row3+2}'] = 'Agente'
    ws_graficas[f'B{start_row3+2}'] = 'Tiempo Captura Prom (min)'
    ws_graficas[f'C{start_row3+2}'] = 'Tiempo Alta Robot Prom (min)'
    
    ws_graficas[f'A{start_row3+2}'].font = Font(bold=True)
    ws_graficas[f'B{start_row3+2}'].font = Font(bold=True)
    ws_graficas[f'C{start_row3+2}'].font = Font(bold=True)
    
    for i, (agente, row) in enumerate(tiempos_por_agente.iterrows(), start=1):
        ws_graficas[f'A{start_row3+2+i}'] = agente
        ws_graficas[f'B{start_row3+2+i}'] = row['Tiempo de captura agente']
        ws_graficas[f'C{start_row3+2+i}'] = row['Tiempo de alta robot']
    
    # Crear gr√°fica de barras agrupadas
    chart3 = BarChart()
    chart3.type = "col"
    chart3.style = 10
    chart3.title = "Tiempos Promedio por Agente"
    chart3.y_axis.title = "Minutos"
    chart3.x_axis.title = "Agente"
    chart3.grouping = "clustered"
    
    data_captura = Reference(ws_graficas, min_col=2, min_row=start_row3+2, 
                           max_row=start_row3+2+len(tiempos_por_agente))
    data_alta = Reference(ws_graficas, min_col=3, min_row=start_row3+2, 
                         max_row=start_row3+2+len(tiempos_por_agente))
    cats3 = Reference(ws_graficas, min_col=1, min_row=start_row3+3, 
                     max_row=start_row3+2+len(tiempos_por_agente))
    
    series1 = Series(data_captura, title="Tiempo Captura")
    series2 = Series(data_alta, title="Tiempo Alta Robot")
    
    chart3.series.append(series1)
    chart3.series.append(series2)
    chart3.set_categories(cats3)
    
    ws_graficas.add_chart(chart3, f"E{start_row3+2}")

# =========================
# MAIN
# =========================
def main():
    logger.info("üöÄ Iniciando generaci√≥n de reporte Excel")
    logger.info(f"üìÇ Archivo fuente: {ARCHIVO_CSV.name}")
    logger.info(f"üìä Archivo destino: {NOMBRE_EXCEL}")
    
    # =========================
    # 1. CARGAR DATOS
    # =========================
    logger.info("üì• Cargando datos del CSV...")
    df = pd.read_csv(ARCHIVO_CSV, dtype=str, encoding='utf-8-sig')
    
    logger.info(f"  Filas originales: {len(df)}")
    
    # =========================
    # 2. FILTRAR POR STATUS
    # =========================
    logger.info("üîç Filtrando datos (eliminando Estatus = False)...")
    if 'Estatus' in df.columns:
        df = df[df['Estatus'] != 'False']
        logger.info(f"  Filas despu√©s de filtrar: {len(df)}")
    else:
        logger.warning("  Columna 'Estatus' no encontrada, continuando sin filtrar")
    
    # =========================
    # 3. SELECCIONAR Y RENOMBRAR COLUMNAS
    # =========================
    logger.info("üìã Seleccionando y renombrando columnas...")
    
    columnas_necesarias = [
        'Fecha', 'Tipo de tarjeta', 'Tipo de aclaracion', 'Detalles de aclaracion',
        'Cargos', 'RobotID', 'AclaracionID', 'Estatus', 'Registro', 'Folio',
        'CIS_1', 'Fecha Creaci√≥n', 'Fecha Enviado', 'Fecha Asignacion', 'Fecha Atendido',
        'NOMBRE', 'Supervisor', 'Site', 'Skill'
    ]
    
    # Verificar qu√© columnas est√°n disponibles
    columnas_disponibles = [col for col in columnas_necesarias if col in df.columns]
    columnas_faltantes = [col for col in columnas_necesarias if col not in df.columns]
    
    if columnas_faltantes:
        logger.warning(f"  Columnas faltantes: {columnas_faltantes}")
    
    df = df[columnas_disponibles].copy()
    
    # =========================
    # 4. PROCESAR FECHAS
    # =========================
    logger.info("‚è∞ Procesando fechas...")
    
    columnas_fecha = ['Fecha', 'Fecha Creaci√≥n', 'Fecha Enviado', 'Fecha Asignacion', 'Fecha Atendido']
    
    for col in columnas_fecha:
        if col in df.columns:
            logger.info(f"  Procesando {col}...")
            df[col] = df[col].apply(parsear_fecha)
    
    # =========================
    # 5. CALCULAR TIEMPOS
    # =========================
    logger.info("‚è±Ô∏è Calculando tiempos...")
    
    # Tiempo de captura agente (Fecha Enviado - Fecha Creaci√≥n) en minutos
    if 'Fecha Enviado' in df.columns and 'Fecha Creaci√≥n' in df.columns:
        df['Tiempo de captura agente'] = df.apply(
            lambda row: calcular_tiempo_minutos(row['Fecha Creaci√≥n'], row['Fecha Enviado']), axis=1
        )
        logger.info(f"  Tiempo de captura agente calculado")
    
    # Tiempo de alta robot (Fecha - Fecha Asignacion) en minutos
    if 'Fecha' in df.columns and 'Fecha Asignacion' in df.columns:
        df['Tiempo de alta robot'] = df.apply(
            lambda row: calcular_tiempo_minutos(row['Fecha Asignacion'], row['Fecha']), axis=1
        )
        logger.info(f"  Tiempo de alta robot calculado")
    
    # Convertir a segundos
    if 'Tiempo de captura agente' in df.columns:
        df['Tiempo de captura agente segundos'] = df['Tiempo de captura agente'] * 60
    
    if 'Tiempo de alta robot' in df.columns:
        df['Tiempo de alta robot segundos'] = df['Tiempo de alta robot'] * 60
    
    # Contar n√∫mero de cargos (suponiendo que es num√©rico)
    if 'Cargos' in df.columns:
        try:
            df['Numero de cargos'] = pd.to_numeric(df['Cargos'], errors='coerce').fillna(0)
        except:
            df['Numero de cargos'] = 0
        logger.info(f"  N√∫mero de cargos calculado")
    
    # =========================
    # 6. RENOMBRAR COLUMNAS
    # =========================
    logger.info("üè∑Ô∏è Renombrando columnas...")
    
    if 'NOMBRE' in df.columns:
        df = df.rename(columns={'NOMBRE': 'Nombre Agente'})
        logger.info("  'NOMBRE' renombrado a 'Nombre Agente'")
    
    if 'Estatus' in df.columns:
        df['Estatus'] = df['Estatus'].replace({'True': 'exitoso'})
        logger.info("  'Estatus' actualizado (True -> exitoso)")
    
    # =========================
    # 7. REORDENAR COLUMNAS FINALES
    # =========================
    logger.info("üìä Estructurando columnas finales...")
    
    columnas_finales = [
        'Fecha', 'Tipo de tarjeta', 'Tipo de aclaracion', 'Detalles de aclaracion',
        'Cargos', 'RobotID', 'AclaracionID', 'Estatus', 'Registro', 'Folio',
        'CIS_1', 'Fecha Creaci√≥n', 'Fecha Enviado', 'Fecha Asignacion', 'Fecha Atendido',
        'Tiempo de captura agente', 'Tiempo de alta robot',
        'Tiempo de captura agente segundos', 'Tiempo de alta robot segundos',
        'Numero de cargos', 'Nombre Agente', 'Supervisor', 'Site', 'Skill'
    ]
    
    # Solo mantener columnas que existen
    columnas_finales_existentes = [col for col in columnas_finales if col in df.columns]
    df = df[columnas_finales_existentes]
    
    logger.info(f"  Columnas finales: {columnas_finales_existentes}")
    logger.info(f"  Filas finales: {len(df)}")
    
    # =========================
    # 8. ELIMINAR ARCHIVOS EXCEL ANTERIORES
    # =========================
    logger.info("üóëÔ∏è Limpiando archivos Excel anteriores...")
    
    # Eliminar archivos de d√≠as anteriores (mantener solo el de hoy)
    for archivo_excel in EXCEL_FOLDER.glob("Reporte_Aclarapp_*.xlsx"):
        if archivo_excel.name != NOMBRE_EXCEL:
            try:
                archivo_excel.unlink()
                logger.info(f"  Eliminado: {archivo_excel.name}")
            except Exception as e:
                logger.warning(f"  No se pudo eliminar {archivo_excel.name}: {e}")
    
    # =========================
    # 9. CREAR ARCHIVO EXCEL CON OPENPYXL
    # =========================
    logger.info(f"üíæ Creando archivo Excel: {RUTA_EXCEL}")
    
    # Crear workbook
    wb = Workbook()
    
    # Crear hoja de datos
    ws_datos = wb.active
    ws_datos.title = "Datos"
    
    # Escribir datos en la hoja
    for r_idx, row in enumerate(df.itertuples(index=False), start=1):
        for c_idx, value in enumerate(row, start=1):
            ws_datos.cell(row=r_idx, column=c_idx, value=value)
    
    # Escribir encabezados
    for c_idx, column_name in enumerate(df.columns, start=1):
        ws_datos.cell(row=1, column=c_idx, value=column_name)
    
    # Aplicar formato
    aplicar_formato_excel(wb, ws_datos, df)
    logger.info("  ‚úÖ Hoja 'Datos' creada con formato")
    
    # Crear gr√°ficas
    crear_graficas_openpyxl(wb, df)
    logger.info("  ‚úÖ Gr√°ficas creadas")
    
    # Guardar archivo
    wb.save(RUTA_EXCEL)
    
    logger.info("‚úÖ Reporte Excel generado exitosamente")
    logger.info(f"üìÑ Archivo: {RUTA_EXCEL}")
    logger.info(f"üìä Total registros en reporte: {len(df)}")
    
    # =========================
    # 10. RESUMEN FINAL
    # =========================
    logger.info("\n" + "="*50)
    logger.info("üìã RESUMEN FINAL DEL REPORTE")
    logger.info("="*50)
    
    if 'Estatus' in df.columns:
        exitosos = df['Estatus'].eq('exitoso').sum()
        logger.info(f"Registros exitosos: {exitosos}/{len(df)}")
    
    if 'Nombre Agente' in df.columns:
        logger.info(f"Agentes √∫nicos: {df['Nombre Agente'].nunique()}")
    
    if 'Tiempo de captura agente' in df.columns:
        tiempo_prom_captura = df['Tiempo de captura agente'].mean()
        logger.info(f"Tiempo promedio de captura: {tiempo_prom_captura:.2f} minutos")
    
    if 'Tiempo de alta robot' in df.columns:
        tiempo_prom_alta = df['Tiempo de alta robot'].mean()
        logger.info(f"Tiempo promedio de alta robot: {tiempo_prom_alta:.2f} minutos")
    
    logger.info("="*50)

# =========================
# EJECUCI√ìN
# =========================
if __name__ == "__main__":
    main()
