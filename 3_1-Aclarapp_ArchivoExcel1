import pandas as pd
import logging
from pathlib import Path
from datetime import datetime, timedelta
import locale
import re

# =========================
# LOGGING
# =========================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

# =========================
# CONFIGURACI√ìN
# =========================
BASE_PATH = Path("c:/Copia-reporte-Aclarabot")
EXCEL_PATH = BASE_PATH / "archivos_Excel"
EXCEL_PATH.mkdir(exist_ok=True)

CSV_FILE = next(BASE_PATH.glob("Acumulado_filtrado_*.csv"))

# Locale espa√±ol (solo para nombre del archivo)
try:
    locale.setlocale(locale.LC_TIME, "Spanish_Spain")
except:
    try:
        locale.setlocale(locale.LC_TIME, "es_ES")
    except:
        logger.warning("‚ö†Ô∏è Locale espa√±ol no disponible")

HOY = datetime.now()
FECHA_TEXTO = HOY.strftime("%d-%B").capitalize()
OUTPUT_FILE = EXCEL_PATH / f"Reporte_Aclarapp_{FECHA_TEXTO}.xlsx"

# =========================
# COLUMNAS DE SALIDA
# =========================
COLUMNAS_SALIDA = [
    "Fecha",
    "Tipo de tarjeta",
    "Tipo de aclaracion",
    "Detalles de aclaracion",
    "Cargos",
    "RobotID",
    "AclaracionID",
    "Estatus",
    "Registro",
    "Folio",
    "CIS",
    "Fecha Creacion",
    "Fecha Enviado",
    "Fecha Asignacion",
    "Fecha Atendido",
    "Tiempo de captura agente",
    "Tiempo de alta robot",
    "Tiempo de captura agente segundos",
    "Tiempo de alta robot segundos",
    "Numero de cargos",
    "Nombre Agente",
    "Supervisor",
    "Site",
    "Skill"
]

# =========================
# FUNCIONES AUXILIARES
# =========================
def convertir_columna_fecha(df, columna):
    """
    Convierte una columna de fecha de formato yyyy-MM-dd HH:mm:ss a datetime
    """
    if columna not in df.columns:
        logger.warning(f"‚ö†Ô∏è Columna '{columna}' no encontrada")
        return df
    
    logger.info(f"üîÑ Convirtiendo columna: {columna}")
    
    valores_antes = df[columna].notna().sum()
    
    if valores_antes == 0:
        logger.info("  ‚ö†Ô∏è No hay valores para convertir")
        return df
    
    try:
        # Intentar convertir del formato yyyy-MM-dd HH:mm:ss
        df[columna] = pd.to_datetime(
            df[columna],
            format='%Y-%m-%d %H:%M:%S',
            errors='coerce'
        )
        
        valores_despues = df[columna].notna().sum()
        logger.info(f"  Valores convertidos: {valores_despues}/{valores_antes}")
        
        if valores_despues < valores_antes:
            no_convertidos = valores_antes - valores_despues
            logger.warning(f"  ‚ö†Ô∏è {no_convertidos} valores no se pudieron convertir")
        
    except Exception as e:
        logger.error(f"‚ùå Error convirtiendo {columna}: {e}")
        df[columna] = pd.to_datetime(df[columna], errors='coerce')
    
    return df

def calcular_tiempo_en_minutos_segundos(segundos_totales):
    """
    Convierte segundos a formato mm:ss
    """
    if pd.isna(segundos_totales) or segundos_totales < 0:
        return None
    
    minutos = int(segundos_totales // 60)
    segundos = int(segundos_totales % 60)
    
    return f"{minutos:02d}:{segundos:02d}"

def calcular_tiempos_agente_robot(df):
    """
    Calcula los tiempos de captura agente y alta robot
    """
    logger.info("\n‚è±Ô∏è CALCULANDO TIEMPOS...")
    
    # =========================
    # 1. TIEMPO DE CAPTURA AGENTE (Fecha Enviado - Fecha Creacion)
    # =========================
    logger.info("\nüîπ Tiempo de captura agente (Fecha Enviado - Fecha Creacion):")
    
    # Verificar columnas necesarias
    columnas_requeridas = ["Fecha Creacion", "Fecha Enviado"]
    for col in columnes_requeridas:
        if col not in df.columns:
            logger.error(f"‚ùå Columna '{col}' no encontrada para c√°lculo")
            return df
    
    # Calcular diferencia en segundos
    mask_fechas_validas = df["Fecha Creacion"].notna() & df["Fecha Enviado"].notna()
    total_filas_validas = mask_fechas_validas.sum()
    
    logger.info(f"  Filas con ambas fechas v√°lidas: {total_filas_validas}/{len(df)}")
    
    if total_filas_validas > 0:
        # Calcular diferencia en segundos
        df.loc[mask_fechas_validas, "Tiempo de captura agente segundos"] = (
            (df.loc[mask_fechas_validas, "Fecha Enviado"] - 
             df.loc[mask_fechas_validas, "Fecha Creacion"]).dt.total_seconds()
        )
        
        # Convertir a formato mm:ss
        df.loc[mask_fechas_validas, "Tiempo de captura agente"] = df.loc[
            mask_fechas_validas, "Tiempo de captura agente segundos"
        ].apply(calcular_tiempo_en_minutos_segundos)
        
        # Estad√≠sticas
        segundos_no_nulos = df["Tiempo de captura agente segundos"].notna().sum()
        logger.info(f"  Tiempos calculados: {segundos_no_nulos}")
        
        if segundos_no_nulos > 0:
            # Mostrar algunos ejemplos
            ejemplos_idx = df[mask_fechas_validas].index[:3]
            for idx in ejemplos_idx:
                fecha_creacion = df.loc[idx, "Fecha Creacion"]
                fecha_enviado = df.loc[idx, "Fecha Enviado"]
                segundos = df.loc[idx, "Tiempo de captura agente segundos"]
                formato_mmss = df.loc[idx, "Tiempo de captura agente"]
                
                logger.info(f"    Ejemplo:")
                logger.info(f"      Fecha Creacion: {fecha_creacion}")
                logger.info(f"      Fecha Enviado: {fecha_enviado}")
                logger.info(f"      Segundos: {segundos}")
                logger.info(f"      Formato mm:ss: {formato_mmss}")
                break  # Solo mostrar un ejemplo
        
        # Estad√≠sticas descriptivas
        if segundos_no_nulos > 0:
            min_seg = df["Tiempo de captura agente segundos"].min()
            max_seg = df["Tiempo de captura agente segundos"].max()
            mean_seg = df["Tiempo de captura agente segundos"].mean()
            
            logger.info(f"  Estad√≠sticas (segundos):")
            logger.info(f"    M√≠nimo: {min_seg:.0f}s ({calcular_tiempo_en_minutos_segundos(min_seg)})")
            logger.info(f"    M√°ximo: {max_seg:.0f}s ({calcular_tiempo_en_minutos_segundos(max_seg)})")
            logger.info(f"    Promedio: {mean_seg:.0f}s ({calcular_tiempo_en_minutos_segundos(mean_seg)})")
    
    # =========================
    # 2. TIEMPO DE ALTA ROBOT (Fecha Atendido - Fecha Asignacion)
    # =========================
    logger.info("\nüîπ Tiempo de alta robot (Fecha Atendido - Fecha Asignacion):")
    
    # Verificar columnas necesarias
    columnas_requeridas = ["Fecha Asignacion", "Fecha Atendido"]
    for col in columnes_requeridas:
        if col not in df.columns:
            logger.error(f"‚ùå Columna '{col}' no encontrada para c√°lculo")
            return df
    
    # Calcular diferencia en segundos
    mask_fechas_validas = df["Fecha Asignacion"].notna() & df["Fecha Atendido"].notna()
    total_filas_validas = mask_fechas_validas.sum()
    
    logger.info(f"  Filas con ambas fechas v√°lidas: {total_filas_validas}/{len(df)}")
    
    if total_filas_validas > 0:
        # Calcular diferencia en segundos
        df.loc[mask_fechas_validas, "Tiempo de alta robot segundos"] = (
            (df.loc[mask_fechas_validas, "Fecha Atendido"] - 
             df.loc[mask_fechas_validas, "Fecha Asignacion"]).dt.total_seconds()
        )
        
        # Convertir a formato mm:ss
        df.loc[mask_fechas_validas, "Tiempo de alta robot"] = df.loc[
            mask_fechas_validas, "Tiempo de alta robot segundos"
        ].apply(calcular_tiempo_en_minutos_segundos)
        
        # Estad√≠sticas
        segundos_no_nulos = df["Tiempo de alta robot segundos"].notna().sum()
        logger.info(f"  Tiempos calculados: {segundos_no_nulos}")
        
        if segundos_no_nulos > 0:
            # Mostrar algunos ejemplos
            ejemplos_idx = df[mask_fechas_validas].index[:3]
            for idx in ejemplos_idx:
                fecha_asignacion = df.loc[idx, "Fecha Asignacion"]
                fecha_atendido = df.loc[idx, "Fecha Atendido"]
                segundos = df.loc[idx, "Tiempo de alta robot segundos"]
                formato_mmss = df.loc[idx, "Tiempo de alta robot"]
                
                logger.info(f"    Ejemplo:")
                logger.info(f"      Fecha Asignacion: {fecha_asignacion}")
                logger.info(f"      Fecha Atendido: {fecha_atendido}")
                logger.info(f"      Segundos: {segundos}")
                logger.info(f"      Formato mm:ss: {formato_mmss}")
                break  # Solo mostrar un ejemplo
        
        # Estad√≠sticas descriptivas
        if segundos_no_nulos > 0:
            min_seg = df["Tiempo de alta robot segundos"].min()
            max_seg = df["Tiempo de alta robot segundos"].max()
            mean_seg = df["Tiempo de alta robot segundos"].mean()
            
            logger.info(f"  Estad√≠sticas (segundos):")
            logger.info(f"    M√≠nimo: {min_seg:.0f}s ({calcular_tiempo_en_minutos_segundos(min_seg)})")
            logger.info(f"    M√°ximo: {max_seg:.0f}s ({calcular_tiempo_en_minutos_segundos(max_seg)})")
            logger.info(f"    Promedio: {mean_seg:.0f}s ({calcular_tiempo_en_minutos_segundos(mean_seg)})")
    
    # =========================
    # 3. RESUMEN FINAL
    # =========================
    logger.info("\nüìä RESUMEN DE C√ÅLCULOS:")
    
    # Tiempo de captura agente
    captura_calculados = df["Tiempo de captura agente"].notna().sum()
    captura_segundos_calc = df["Tiempo de captura agente segundos"].notna().sum()
    logger.info(f"  Tiempo de captura agente: {captura_calculados} calculados")
    logger.info(f"  Tiempo de captura agente segundos: {captura_segundos_calc} calculados")
    
    # Tiempo de alta robot
    alta_calculados = df["Tiempo de alta robot"].notna().sum()
    alta_segundos_calc = df["Tiempo de alta robot segundos"].notna().sum()
    logger.info(f"  Tiempo de alta robot: {alta_calculados} calculados")
    logger.info(f"  Tiempo de alta robot segundos: {alta_segundos_calc} calculados")
    
    # Ejemplos finales
    if captura_calculados > 0:
        fila_ejemplo = df[df["Tiempo de captura agente"].notna()].iloc[0]
        logger.info(f"\n  Ejemplo final de c√°lculos:")
        logger.info(f"    Tiempo de captura agente: {fila_ejemplo['Tiempo de captura agente']}")
        logger.info(f"    Tiempo de captura agente segundos: {fila_ejemplo['Tiempo de captura agente segundos']}")
    
    if alta_calculados > 0:
        if captura_calculados == 0:
            fila_ejemplo = df[df["Tiempo de alta robot"].notna()].iloc[0]
            logger.info(f"\n  Ejemplo final de c√°lculos:")
        logger.info(f"    Tiempo de alta robot: {fila_ejemplo['Tiempo de alta robot']}")
        logger.info(f"    Tiempo de alta robot segundos: {fila_ejemplo['Tiempo de alta robot segundos']}")
    
    return df

# =========================
# MAIN
# =========================
def main():
    logger.info("üöÄ Generando Reporte Excel Aclarapp con c√°lculos de tiempo")

    # =========================
    # CARGA CSV
    # =========================
    df = pd.read_csv(CSV_FILE, dtype=str, encoding="utf-8-sig")
    logger.info(f"‚úì CSV cargado: {CSV_FILE.name} ({len(df)} filas)")

    # =========================
    # VERIFICAR COLUMNAS DE FECHA EXISTENTES
    # =========================
    logger.info("\nüîç VERIFICANDO COLUMNAS DE FECHA...")
    
    columnas_fecha = [
        "Fecha",
        "Fecha Creacion",  # Nota: en el CSV original es "Fecha Creaci√≥n" con acento
        "Fecha Enviado",
        "Fecha Asignacion",
        "Fecha Atendido"
    ]
    
    # Verificar qu√© columnas realmente existen
    columnas_existentes = []
    for col in columnas_fecha:
        if col in df.columns:
            columnas_existentes.append(col)
            logger.info(f"  ‚úì {col}: encontrada")
        else:
            # Buscar variantes (con acentos, etc.)
            posibles_variantes = {
                "Fecha Creacion": ["Fecha Creaci√≥n", "Fecha_Creacion", "FechaCreacion"],
                "Fecha Enviado": ["Fecha_Enviado", "FechaEnviado"],
                "Fecha Asignacion": ["Fecha_Asignacion", "FechaAsignacion", "Fecha Asignaci√≥n"],
                "Fecha Atendido": ["Fecha_Atendido", "FechaAtendido"]
            }
            
            encontrada = False
            if col in posibles_variantes:
                for variante in posibles_variantes[col]:
                    if variante in df.columns:
                        # Renombrar para uniformidad
                        df = df.rename(columns={variante: col})
                        columnas_existentes.append(col)
                        logger.info(f"  ‚úì {variante} ‚Üí renombrada a {col}")
                        encontrada = True
                        break
            
            if not encontrada:
                logger.warning(f"  ‚ö†Ô∏è {col}: NO encontrada")
    
    logger.info(f"Total columnas de fecha a procesar: {len(columnas_existentes)}")

    # =========================
    # CONVERTIR COLUMNAS DE FECHA A DATETIME
    # =========================
    logger.info("\nüìÖ CONVIRTIENDO COLUMNAS DE FECHA A DATETIME...")
    
    for col in columnas_existentes:
        df = convertir_columna_fecha(df, col)

    # =========================
    # FILTRAR ESTATUS TRUE
    # =========================
    logger.info("\nüîç FILTRANDO POR ESTATUS = TRUE...")
    
    if "Estatus" in df.columns:
        filas_antes = len(df)
        df = df[df["Estatus"] == "True"].copy()
        filas_despues = len(df)
        logger.info(f"  Estatus='True' ‚Üí {filas_despues} filas (de {filas_antes})")
    else:
        logger.warning("‚ö†Ô∏è No se pudo encontrar columna 'Estatus'. Saltando filtro.")

    # =========================
    # LIMPIAR CIS / CIS_1
    # =========================
    logger.info("\nüßπ LIMPIANDO COLUMNAS CIS...")
    
    for col in ["CIS", "CIS_1"]:
        if col in df.columns:
            valores_antes = df[col].notna().sum()
            
            df[col] = (
                df[col]
                .astype(str)
                .str.replace(r"\D+", "", regex=True)
                .replace("nan", None)
                .replace("", None)
            )
            
            valores_despues = df[col].notna().sum()
            logger.info(f"  {col}: {valores_despues}/{valores_antes} valores despu√©s de limpiar")

    # =========================
    # CALCULAR TIEMPOS DE AGENTE Y ROBOT
    # =========================
    df = calcular_tiempos_agente_robot(df)

    # =========================
    # OTRAS TRANSFORMACIONES
    # =========================
    logger.info("\n‚öôÔ∏è APLICANDO OTRAS TRANSFORMACIONES...")
    
    # Convertir "Cargos" a n√∫mero
    if "Cargos" in df.columns:
        df["Numero de cargos"] = pd.to_numeric(
            df["Cargos"], errors="coerce"
        )
        logger.info(f"‚úì 'Cargos' convertido a n√∫mero para 'Numero de cargos'")
    else:
        df["Numero de cargos"] = None
    
    # Cambiar Estatus a "Exitoso"
    if "Estatus" in df.columns:
        df["Estatus"] = "Exitoso"
        logger.info("‚úì 'Estatus' cambiado a 'Exitoso'")
    
    # Renombrar columna de nombre agente si existe
    posibles_nombres_agente = ["NOMBRE", "Nombre", "nombre", "Agente", "agente", "Nombre Agente"]
    for nombre in posibles_nombres_agente:
        if nombre in df.columns:
            if nombre != "Nombre Agente":  # Solo renombrar si no es ya el nombre correcto
                df = df.rename(columns={nombre: "Nombre Agente"})
                logger.info(f"‚úì {nombre} ‚Üí renombrada a 'Nombre Agente'")
            break
    
    if "Nombre Agente" not in df.columns:
        logger.warning("‚ö†Ô∏è No se encontr√≥ columna para 'Nombre Agente'")
        df["Nombre Agente"] = None

    # =========================
    # VERIFICAR COLUMNAS ANTES DE SELECCI√ìN
    # =========================
    logger.info("\nüîç VERIFICANDO COLUMNAS PARA SALIDA...")
    
    columnas_faltantes = []
    columnas_existentes = []
    
    for col in COLUMNAS_SALIDA:
        if col in df.columns:
            columnas_existentes.append(col)
        else:
            columnas_faltantes.append(col)
    
    logger.info(f"Columnas disponibles: {len(columnas_existentes)}/{len(COLUMNAS_SALIDA)}")
    
    if columnas_faltantes:
        logger.warning("Columnas faltantes:")
        for col in columnas_faltantes:
            logger.warning(f"  ‚ö†Ô∏è {col}")
        
        # Crear columnas faltantes vac√≠as
        for col in columnas_faltantes:
            df[col] = None
        logger.info("‚úì Columnas faltantes creadas como vac√≠as")

    # =========================
    # SELECCI√ìN FINAL Y ORDEN
    # =========================
    logger.info("\nüìã PREPARANDO DATAFRAME FINAL...")
    df_final = df[COLUMNAS_SALIDA].copy()
    
    # Ordenar por fecha si existe
    if "Fecha" in df_final.columns and df_final["Fecha"].notna().any():
        df_final = df_final.sort_values("Fecha", ascending=True)
        logger.info("‚úì Datos ordenados por 'Fecha'")
    
    logger.info(f"‚úì DataFrame final: {len(df_final)} filas √ó {len(df_final.columns)} columnas")

    # =========================
    # VERIFICAR RESULTADOS DE C√ÅLCULOS
    # =========================
    logger.info("\nüîç VERIFICANDO RESULTADOS DE C√ÅLCULOS...")
    
    # Verificar tiempos calculados
    if "Tiempo de captura agente" in df_final.columns:
        captura_calc = df_final["Tiempo de captura agente"].notna().sum()
        captura_seg_calc = df_final["Tiempo de captura agente segundos"].notna().sum()
        
        if captura_calc > 0:
            ejemplo = df_final[df_final["Tiempo de captura agente"].notna()].iloc[0]
            logger.info(f"‚úì Tiempo de captura agente: {captura_calc} calculados")
            logger.info(f"  Ejemplo: {ejemplo['Tiempo de captura agente']} (={ejemplo['Tiempo de captura agente segundos']}s)")
        else:
            logger.warning("‚ö†Ô∏è No se calcularon tiempos de captura agente")
    
    if "Tiempo de alta robot" in df_final.columns:
        alta_calc = df_final["Tiempo de alta robot"].notna().sum()
        alta_seg_calc = df_final["Tiempo de alta robot segundos"].notna().sum()
        
        if alta_calc > 0:
            ejemplo = df_final[df_final["Tiempo de alta robot"].notna()].iloc[0]
            logger.info(f"‚úì Tiempo de alta robot: {alta_calc} calculados")
            logger.info(f"  Ejemplo: {ejemplo['Tiempo de alta robot']} (={ejemplo['Tiempo de alta robot segundos']}s)")
        else:
            logger.warning("‚ö†Ô∏è No se calcularon tiempos de alta robot")

    # =========================
    # EXPORTAR EXCEL
    # =========================
    logger.info(f"\nüì§ Exportando Excel: {OUTPUT_FILE}")
    
    with pd.ExcelWriter(
        OUTPUT_FILE,
        engine='openpyxl',
        date_format='yyyy-mm-dd hh:mm:ss',
        datetime_format='yyyy-mm-dd hh:mm:ss'
    ) as writer:
        df_final.to_excel(
            writer,
            index=False,
            sheet_name='Reporte'
        )
        
        # Ajustar ancho de columnas
        workbook = writer.book
        worksheet = writer.sheets['Reporte']
        
        for column in worksheet.columns:
            max_length = 0
            column_letter = column[0].column_letter
            
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            
            adjusted_width = min(max_length + 2, 50)
            worksheet.column_dimensions[column_letter].width = adjusted_width

    logger.info("‚úÖ Reporte Excel generado correctamente")
    logger.info(f"üìä Filas finales: {len(df_final)}")
    logger.info(f"üìÅ Ubicaci√≥n: {OUTPUT_FILE}")
    
    # Resumen final
    logger.info("\nüìã RESUMEN FINAL:")
    logger.info("="*60)
    logger.info(f"Archivo: {OUTPUT_FILE.name}")
    logger.info(f"Total filas: {len(df_final)}")
    
    if "Tiempo de captura agente" in df_final.columns:
        calc = df_final["Tiempo de captura agente"].notna().sum()
        logger.info(f"Tiempos de captura agente calculados: {calc}")
    
    if "Tiempo de alta robot" in df_final.columns:
        calc = df_final["Tiempo de alta robot"].notna().sum()
        logger.info(f"Tiempos de alta robot calculados: {calc}")
    
    logger.info("="*60)

# =========================
# EJECUCI√ìN
# =========================
if __name__ == "__main__":
    main()
