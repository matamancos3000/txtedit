from pywinauto import Desktop
import time
from datetime import datetime

# ---------- CONFIG ----------
SEARCH_TEXT = "MX CWX Desktop (2)"    
DELAY_BEFORE_MINIMIZE = 10            # segundos
DELAY_BEFORE_RESTORE = 10             # segundos
CYCLE_INTERVAL = 30                   # segundos entre ciclos (21600 = 6 horas)
# -----------------------------

def now():
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def sec_to_min_str(sec):
    mins = sec / 60
    if mins == 1:
        return f"{sec}s (1 minuto)"
    else:
        return f"{sec}s ({mins:.1f} minutos)"

print(f"[{now()}] Iniciando monitor. Buscando ventanas que contengan: '{SEARCH_TEXT}'\n")

while True:
    try:
        found = False
        windows = Desktop(backend="win32").windows()

        for w in windows:
            try:
                title = w.window_text()
            except:
                title = ""
            
            if SEARCH_TEXT in title:
                found = True
                print(f"[{now()}] → Ventana encontrada: '{title}'")

                # Espera antes de minimizar
                print(f"[{now()}]   - Esperando {sec_to_min_str(DELAY_BEFORE_MINIMIZE)} antes de minimizar...")
                time.sleep(DELAY_BEFORE_MINIMIZE)

                # Minimizar SOLO si es posible
                try:
                    if w.is_minimized() is False:        # no minimizar si ya está minimizada
                        print(f"[{now()}]   - Minimizando ventana...")
                        w.minimize()
                    else:
                        print(f"[{now()}]   - La ventana ya estaba minimizada, no se minimiza.")
                except Exception as e_min:
                    print(f"[{now()}]   - No se pudo minimizar (probablemente ventana no minimizable).")

                # Espera antes de restaurar
                print(f"[{now()}]   - Esperando {sec_to_min_str(DELAY_BEFORE_RESTORE)} antes de restaurar...")
                time.sleep(DELAY_BEFORE_RESTORE)

                # Restaurar SOLO si es posible
                try:
                    if w.is_minimized():
                        print(f"[{now()}]   - Restaurando ventana...")
                        w.restore()
                    else:
                        print(f"[{now()}]   - La ventana no estaba minimizada, no se restaura.")
                except Exception:
                    print(f"[{now()}]   - No se pudo restaurar (quizá no es restaurable).")

                print(f"[{now()}]   ✔ Ciclo completado para '{title}'\n")

        if not found:
            print(f"[{now()}] ℹ No se encontró ninguna ventana que contenga '{SEARCH_TEXT}'. (seguiré buscando)")

    except Exception as e:
        print(f"[{now()}] ⚠ Error inesperado: {e}")

    print(f"[{now()}] ⏳ Esperando {sec_to_min_str(CYCLE_INTERVAL)} para el próximo ciclo...\n")
    time.sleep(CYCLE_INTERVAL)
